<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。                             ">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->

    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta
            content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
            name="viewport"
    />

</head>
<style>
    .card {
        border-radius: 0.5rem;
    }

    .icon {
        width: 1.5rem;
        height: 1rem;
    }

    .table td {
        padding: 0.4rem;
        vertical-align: middle;
        border-top: .125rem solid #dee2e6;
    }
    .truncate {
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .row input{
            width: 100%;
    }
</style>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <div class="container" style="height: 48rem;">
        <div class="card" style="margin-top: 4rem">
            <div class="card-header d-flex justify-content-between align-items-center" style="padding: 0.3rem 0.8rem;">
                <h5 style="margin-bottom: 0;">资源下载</h5>
                <span>
                     <button type="button" class="btn btn-primary" data-toggle="modal"
                             data-target="#uploadModal">
                    上传
                    </button>
                </span>

            </div>
            <div class="card-table table-responsive">
                <table class="table table-vcenter">
                    <thead>
                    <tr>
<!--                        <th>标题</th>-->
                        <th>文件名称</th>
                        <th>描述</th>
                        <th>下载量</th>
                        <th>文件大小</th>
                        <th>上传用户</th>
                        <th>上传时间</th>
                    </tr>
                    </thead>
                    <tbody id="list">
<!--                    <tr>-->
<!--                        <td>-->
<!--                            /about.html-->
<!--                            <a href="#" class="ms-1" aria-label="Open website">-->
<!--                                &lt;!&ndash; Download SVG icon from http://tabler-icons.io/i/link &ndash;&gt;-->
<!--                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"-->
<!--                                     viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"-->
<!--                                     stroke-linecap="round" stroke-linejoin="round">-->
<!--                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>-->
<!--                                    <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5"></path>-->
<!--                                    <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5"></path>-->
<!--                                </svg>-->
<!--                            </a>-->
<!--                        </td>-->
<!--                        <td class="text-muted">4,896</td>-->
<!--                        <td class="text-muted">3,654</td>-->
<!--                        <td class="text-muted">82.54%</td>-->
<!--                    </tr>-->
                    </tbody>
                </table>
                <div class="card-footer d-flex align-items-center justify-content-end">
                    <ul class="pagination m-0 ms-auto" id="page-module">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="15 6 9 12 15 18"></polyline></svg>
                            </a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="9 6 15 12 9 18"></polyline></svg>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">资源上传</h5>
                </div>
                    <form class="form-group form-check needs-validation " style="padding-left: 0;" id="uploadImgForm">
                        <div class="modal-body">
                            <div class="row">
                                    <input type="text" class="form-control form-control-sm" id="title"
                                           placeholder="请输入标题" required>
                                    <div class="invalid-feedback">请输入标题</div>
                            </div>
                            <div class="row">
                                    <input type="text" class="form-control form-control-sm" id="description"
                                           placeholder="请输入描述" required>
                                    <div class="invalid-feedback">请输入描述</div>
                            </div>
                            <div class="row justify-content-between">
                                <label class="col-sm-6 col-form-label">是否全站公开可见</label>
                                <div class="col-sm-2 d-flex align-items-center">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="isPublic">
                                        <span class="toggle-switch-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="row justify-content-between">
                                <label class="col-sm-6 col-form-label">是否临时文件(保存7天)</label>
                                <div class="col-sm-2 d-flex align-items-center">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="isTemporary">
                                        <span class="toggle-switch-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="row">
                                    <div class="input-group">
                                        <input type="file" name="file-1[]" class="form-control" id="file-1" aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                                    </div>
                                    <small class="form-text text-muted">支持1GB以内资源上传</small>
                            </div>
                            <div class=" justify-content-between align-items-center">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">返回</button>
                                <button type="button" class="btn btn-primary" onclick="submitForm()">提交</button>
                            </div>
                        </div>
                    </form>

                <div class="progress" style="margin-bottom: 0;" role="progressbar" aria-label="Example with label" aria-valuenow="0"
                     aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width: 0%"  id="progressBar">0%</div>
                </div>
                </div>
        </div>
    </div>
</main>
<!-- 页面底部 -->
<div id="footer"></div>

<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>

<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>
<script>
    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        $('#footer').load("../pages/footer.html", insertCreateTime);
        list(1, 10)
    }

    // 进度条更新
    function progressHandle(e) {
        const progress = document.querySelector('.progress-bar');
        const percent = (e.loaded / e.total * 100).toFixed(2);
        progress.style.width = percent + "%";
        progress.innerHTML = percent + "%";
    }

    function submitForm() {

        checkFileSize()
        if (null==localStorage.getItem('user-token')){
            alert("需要登录后上传")
        }
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const fileInput = document.getElementById("file-1");
        const isPublic = document.getElementById("isPublic").value;
        const isTemporary = document.getElementById("isTemporary").value;

        const files = fileInput.files;

        if (files.length === 0) {
            alert("请选择文件后再上传");
            return; // Prevent form submission
        }

        // 创建FormData对象并添加表单数据
        const formData = new FormData();
        formData.append("title", title);
        formData.append("description", description);
        formData.append("isPublic", isPublic);
        formData.append("isTemporary", isTemporary);
        for (let i = 0; i < files.length; i++) {
            formData.append("files", files[i]);
        }

        const get = new XMLHttpRequest();

        get.open("POST", "/api/anakki/resource/upload");

        get.onreadystatechange = function () {
            const response = JSON.parse(get.responseText);
            if (get.readyState === 4 && get.status === 200) {
                if (response.code === 200) {
                    alert("上传成功");
                    list(1, 10);
                    hideUploadModalAndResetProgress(); // 隐藏模态框并重置进度条
                } else {
                    alert(response.data);
                }
            }
        };
        get.setRequestHeader('authorization', localStorage.getItem('user-token'));
        if (get.upload) {
            //处理进度条的事件
            get.upload.addEventListener("progress", progressHandle,
                false);
        }
        get.send(formData);
    }

    function hideUploadModalAndResetProgress() {
        $('#uploadModal').modal('hide');
        // 重置进度条
        var progressBar = document.getElementById("progressBar");
        progressBar.value = 0;
    }
    function list(current, pageSize, searchInput) {
        const url = window.location.href;
        const get = new XMLHttpRequest();
        get.open("GET", "/base/anakki/resource/list?current=" + current + "&size=" + pageSize, true);
        get.onreadystatechange = function () {
            if (get.readyState === 4 && get.status === 200) {
                let html = "";
                const response = JSON.parse(get.responseText);

                const itemList = response.data.data;
                const totalNum = response.data.totalNum;

                for (let i = 0; i < itemList.length; i++) {
                    const item = itemList[i];
                    const id = item.id;
                    const type = item.type;
                    const resourceName = item.resourceName;
                    const title = item.title;
                    const downloadCount = item.downloadCount;
                    const description = item.description;
                    let fileSize;
                    if (item.fileSize<1024){
                        fileSize= (item.fileSize).toFixed(2)+"KB"
                    }else if(item.fileSize>1024&&item.fileSize<1024*1024){
                        fileSize= (item.fileSize/1024).toFixed(2)+"MB"
                    }else if(item.fileSize>1024*1024*1024){
                        fileSize= (item.fileSize/(1024*1024)).toFixed(2)+"GB"
                    }

                    const createTime = item.createTime.replace("T","");
                    const uploadUser = item.uploadUser;
                    html = html + "                           <tr>\n" +
                        "                                    <td>" + resourceName + "</td>\n" +
                        "                                    <td class=\"truncate\">" + description + "</td>\n" +
                        "                                    <td>" + downloadCount + "</td>\n" +
                        "                                    <td>" + fileSize + "</td>\n" +
                        "                                    <td>" + uploadUser + "</td>\n" +
                        "                                    <td>" + createTime + "</td>\n" +
                        "    <td>\n" +
                        "        <button class=\"btn btn-success\" onclick=\"downloadResource(" + id + ")\">下载</button>\n" +
                        "        <button class=\"btn btn-success\" onclick=\"deleteResource(" + id + ")\">删除</button>\n" +
                        "    </td>\n" +
                        "                                </tr>"
                }
                document.getElementById("list").innerHTML = html;
                let totalPages = Math.ceil(totalNum / pageSize);
                initPage(current, pageSize, totalPages);
                // 拼接分页参数到地址栏
                const newUrl = url.split("?")[0] + "?current=" + current + "&size=" + pageSize;
                window.history.replaceState(null, null, newUrl);
            }
        };
        get.setRequestHeader('authorization', localStorage.getItem('user-token'));
        get.send();
    }


    function initPage(currentPage, pageSize, totalPages) {
        const paginationContainer = document.getElementById("page-module");
        let html = "";
        // Previous page button
        if (currentPage > 1) {
            let number = currentPage - 1;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${number}, '${pageSize}')"><</a></li>`;
        } else {
            html += `<li class="page-item disabled"><a class="page-link" href="#"><<</a></li>`;
        }
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${i}, '${pageSize}')">${i}</a></li>`;
            }
        }
        // Next page button
        if (currentPage < totalPages) {
            let number = currentPage + 1;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${number}, '${pageSize}')">></li>`;
        } else {
            html += `<li class="page-item disabled"><a class="page-link" href="#">>></a></li>`;
        }
        paginationContainer.innerHTML = html;
    }

    function checkFileSize() {
        var input = document.getElementById('file-1');
        if (input.files.length > 0) {
            var fileSize = input.files[0].size; // size in bytes
            var maxSize = 1024 * 1024 * 1024; // 1GB in bytes
            if (fileSize > maxSize) {
                alert('文件大小超过1GB，请选择小于1GB的文件进行上传。');
                return false; // Prevent form submission
            }
        }
    }
    function downloadResource(id) {
        if (null==localStorage.getItem('user-token')){
            alert("需要登录后下载")
        }
        const get = new XMLHttpRequest();
        get.open("GET", "/api/anakki/resource/download?key=" + id, true);
        get.onreadystatechange = function () {
            if (get.readyState === 4 && get.status === 200) {
                const response = JSON.parse(get.responseText);
                if (101 === response.code) {
                    alert(response.data)
                } else {
                    const downloadUrl = response.data;
                    window.open(downloadUrl);
                }
            }
        };
        get.setRequestHeader('authorization', localStorage.getItem('user-token'));
        get.send();
    }
    function deleteResource(id) {
        if (null == localStorage.getItem('user-token')) {
            alert("需要登录后操作");
            return; // 防止进一步执行
        }
        var isConfirmed = confirm("确定要删除这个资源吗？");
        if (!isConfirmed) {
            return; // If the user clicks "Cancel", stop the function
        }
        // 创建JSON对象包含资源ID
        const data = JSON.stringify({"id": id});

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/anakki/resource/remove", true);

        // 设置请求头以发送JSON数据
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader('Authorization', localStorage.getItem('user-token'));
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (101 === response.code) {
                    alert(response.data)
                } else {
                    list(1, 10)
                }
            }
        };

        // 发送包含ID的JSON数据
        xhr.send(data);
    }

</script>
</body>
</html>