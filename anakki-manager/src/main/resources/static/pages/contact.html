<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Probably the most complete UI kit out there. Multiple functionalities and controls added,  extended color palette and beautiful typography, designed as its own extended version of Bootstrap at  the highest level of quality.                             ">
    <meta name="author" content="Webpixels">
    <title>Anakki-World</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700,800|Roboto:400,500,700" rel="stylesheet">
    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <style>
        body {
            color: #495751b8;
            background-color: #035e0082;
        }

        .card {
            border: .0625rem solid rgba(0, 0, 0, 0.05);
            border-radius: 0.7rem;
        }

        .time-margin {
            margin-right: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .card-body {
            flex: 1 1 auto;
            padding: 1.1rem;
        }
    </style>
</head>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <section class="slice slice-xl bg-cover bg-size--cover" data-spotlight="fullscreen"
             style="background-image: url('https://securex-1258150206.cos.ap-beijing.myqcloud.com/backend/DSC07694.jpg')">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-7">
                    <div class="text-center pt-lg-md">
                        <h2 class="heading h1 mb-4">
                            说点什么
                        </h2>
                        <p class="lead lh-180">
                            加密留言将会加密存储，站长也需密钥才能查看。公开留言所有人可见。普通留言只能站长查看。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="slice slice-lg">
        <div class="container">
            <div class="row align-items-center cols-xs-space cols-sm-space cols-md-space">
                <div class="col-lg-6">
                    <h3 class="heading h3 mb-4">留言板</h3>
                    <form id="commentForm">
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <input class="form-control" placeholder="你的昵称" type="text" id="nicknameInput" style="display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <input class="form-control" placeholder="邮箱" type="email" id="emailInput" style="display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <textarea class="form-control" rows="5" placeholder="留言内容" name="comment"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary px-4" id="anonymousButton" onclick="toggleAnonymousFields()">
                                匿名留言
                            </button>
                            <button type="submit" class="btn btn-primary px-4">
                                飞鸽传书
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-lg-5 ml-lg-auto">
                    <h3 class="heading heading-3 strong-300">
                        留言永久保存
                        <br>
                        支持时空漂流瓶，自定义送达时间。
                    </h3>
                    <p>朝辞白帝彩云间</p>
                    <p>千里江陵一日还</p>
                    <p>两岸猿声啼不住</p>
                    <p>轻舟已过万重山</p>
                </div>
            </div>
        </div>
    </section>
    <section class="slice slice-lg">
        <div class="container">
            <div class="row align-items-center cols-xs-space cols-sm-space cols-md-space">
                <div class="col-lg-8">
                    <h3 class="heading h3 mb-4">好友留言</h3>
                    <div class="row">
                        <div id="friend-comment" class="list-group">
                            <!--留言填充-->
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 ml-lg-auto">
                    <h3 class="heading heading-3 strong-300">
                        善语结良缘，恶言伤人心
                    </h3>
                </div>
            </div>
        </div>
    </section>

</main>
<!-- 页面底部 -->
<div id="footer"></div>
<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>

<script>

    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        $('#footer').load("../pages/footer.html",insertCreateTime);
        const mainPageImageFlow = new XMLHttpRequest();
        mainPageImageFlow.open("GET", "/base/anakki/friends-comment/list-comments", true);
        mainPageImageFlow.onreadystatechange = function () {
            if (mainPageImageFlow.readyState === 4 && mainPageImageFlow.status === 200) {
                let html = "";
                const response = JSON.parse(mainPageImageFlow.responseText);
                const itemList = response.data.data;
                for (let i = 0; i < itemList.length; i++) {
                    const item = itemList[i];
                    let time = item.createTime;
                    const formattedDateTime = time.replace("T", " ");
                    //计算距离现在时间
                    const targetDate = new Date(time);
                    const currentDate = new Date();
                    // Calculate the difference in milliseconds
                    const timeDiff = currentDate.getTime() - targetDate.getTime();
                    // Convert milliseconds to days
                    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    let daysBefore = "";
                    if (0 === daysDiff) {
                        daysBefore = "今天";
                    } else {
                        daysBefore = daysDiff + "天以前";
                    }
                    // html = html + "<div class=\"list-group-item list-group-item-action\">" +
                    //     "<div class=\"d-flex w-100 justify-content-between\">" +
                    //     "<h5 class=\"mb-1\">" + item.nickname + "</h5>" +
                    //     "<small>" + daysBefore + "</small>" +
                    //     "</div>" +
                    //     "<p class=\"mb-1\">" + item.comment + "</p>" +
                    //     "<small>" + formattedDateTime + "</small>" +
                    //     "</div>";

                    html = html +
                        "<div class=\"card mb-3 \" style=\"max-width: 1000px;\">\n" +
                            "<div class=\"row g-0\">\n" +
                                "<div class=\"col-md-4\">\n" +
                                    "<div class=\"card-body\">\n" +
                                        "<img src=\"" + (item.avatar ? item.avatar : "default-avatar.jpg") + "\" class=\"img-fluid rounded-start\" alt=\"avatar\">\n" +
                                    "</div>\n" +
                                "</div>\n" +
                                "<div class=\"col-md-8\">\n" +
                                     "<div class=\"card-body\">\n" +
                                        "<div class=\"row\">\n" +
                                            "<h5 class=\"card-title\">" + item.nickname + "</h5>\n" +
                                            "<p class=\"card-text\" style=\"padding-right: 1.0rem;\">" + item.comment + "</p>\n" +
                                        "</div>" +
                                    "</div>\n" +
                                "</div>\n" +
                            "</div>\n" +
                            "<div class=\"row align-self-end\">\n" +
                                "<div class=\"col\">\n" +
                                    "<p class=\"card-text\" style=\"padding: 0.5rem 1.5rem; margin: 0.2rem;\"><small class=\"text-body-secondary\">" + formattedDateTime + "</small></p>\n" +
                                "</div>\n" +
                            "</div>\n" +
                        "</div>";
                    ;
                }
                document.getElementById("friend-comment").innerHTML = html;
            }
        };
        mainPageImageFlow.send();
    };

    $(document).ready(function() {
        $('#commentForm').submit(function(e) {
            e.preventDefault(); // Prevent form submission
            var formData = $(this).serialize(); // Serialize form data

            $.ajax({
                url: '/api/anakki/friends-comment/create-comment', // Replace with your server URL
                type: 'POST',
                data: formData,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('authorization', localStorage.getItem('user-token')); // Include the token in the Authorization header
                },
                success: function(response) {
                    // Handle success response
                    console.log(response);
                    location.reload(); // Reload the page
                },
                error: function(xhr, status, error) {
                    // Handle error response
                    console.log(error);
                }
            });
        });
    });


    function toggleAnonymousFields() {
        var nicknameInput = document.getElementById("nicknameInput");
        var emailInput = document.getElementById("emailInput");
        var submitButton = document.querySelector("#commentForm button[type='submit']");
        var anonymousButton = document.getElementById("anonymousButton");
        if (nicknameInput.style.display === "none") {
            nicknameInput.style.display = "block";
            emailInput.style.display = "block";
            anonymousButton.textContent = "取消匿名";
        } else {
            nicknameInput.style.display = "none";
            emailInput.style.display = "none";
            anonymousButton.textContent = "匿名留言";
        }
    }

    const generateDefaultAvatar = () => {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const size = 200; // 头像尺寸
        // 设置画布尺寸
        canvas.width = size;
        canvas.height = size;
        // 绘制默认头像
        context.fillStyle = '#e0e0e0'; // 头像背景颜色
        context.fillRect(0, 0, size, size);
        context.fillStyle = '#bdbdbd'; // 头像图案颜色
        context.beginPath();
        context.arc(size / 2, size / 2, size / 2 - 5, 0, 2 * Math.PI);
        context.fill();
        // 获取Base64编码的头像图片
        const base64Image = canvas.toDataURL('image/png');
        return base64Image;
    };
    // 使用示例
    const defaultAvatar = generateDefaultAvatar();

</script>
</body>
</html>