<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->

    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            color: #495751b8;
            background-color: #035e0082;
        }

        .card {
            border: .0625rem solid rgba(0, 0, 0, 0.05);
            border-radius: 0.7rem;
        }

        .time-margin {
            margin-right: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .card-body {
            flex: 1 1 auto;
            padding: 1.1rem;
        }

        .modal-title {
            line-height: 1.6;
            margin: 1.0rem 1.5rem;
        }

        @media (min-width: 576px) {
            .modal-dialog {
                max-width: 580px;
                margin: 6.75rem auto;
            }
        }
        .comment-card {
            border: 0px 1px solid #020202;
            border-radius: 15px;
            background-color: #0000004f;
            width: 100%;
            transition: width 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .comment-card:hover {
            background-color: rgba(0, 0, 0, 0.32);
            box-shadow: 0 0 24px rgba(0, 0, 0, 0.35);
            width: 98%; /* 宽度平滑增加 */
        }
        .avatar-size {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 25% !important;
            margin: 0.5rem 0.0rem 0.0rem 0.5rem;
        }

        .comment-card .card-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: aqua;
        }

        .comment-card .card-time {
            font-size: 0.75rem;
            color: #e8e8e8;
            font-weight: bold;
        }

        .comment-card .card-text {
            font-size: 0.85rem;
            color: #e8e8e8;
            font-weight: bold;
        }

        .comment-card .btn {
            font-size: 0.8rem;
        }

        .comment-card .btn-outline-primary {
            color: #1da1f2;
            border-color: #1da1f2;
        }

        .comment-card .btn-outline-primary:hover {
            background-color: #e1ecf4;
        }

        .comment-card .btn-outline-secondary {
            color: #c8c8c8;
            border-color: #e1e8ed;
        }

        .comment-card .btn-outline-secondary:hover {
            background-color: #f5f8fa;
        }

        .comment-open-button:hover {
            transform: scale(1.1); /* 放大1.1倍，你可以根据需要调整 */
        }

        .spotlight {
            height: 100vh; /* 使背景区域覆盖整个视口高度 */
            background-size: cover;
            background-position: center;
            min-height: 1080px;
        }

        .spinner-border {
            margin: 20px auto; /* 使加载动画居中 */
        }
        p {
            margin-top: 0;
            margin-bottom: 0;
        }

        .page-link {
            position: relative;
            display: block;
            padding: .5rem .75rem;
            margin-left: -0.0625rem;
            line-height: 1.25;
            color: #d0d0d0;
            background-color: #0000005c;
            border: .0625rem solid #dee2e600;
        }
        .commentSendBtn{
            justify-content: center;
            display: flex;
        }

        .breathing-effect {
            display: inline-block; /* 使 span 元素支持 transform */
            animation: breathing 2s ease-in-out infinite; /* 动画名称、时长、速度曲线、循环次数 */
        }

        @keyframes breathing {
            0% {
                transform: scale(1); /* 初始状态 */
                opacity: 1;
            }
            50% {
                transform: scale(1.2); /* 扩大 1.2 倍 */
                opacity: 0.7;
            }
            100% {
                transform: scale(1); /* 恢复到原始状态 */
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <section class="slice slice-xl bg-cover bg-size--cover  spotlight" data-spotlight="fullscreen"
             style="background-image: url('https://securex-1258150206.cos.ap-beijing.myqcloud.com/backend/DSC07694.jpg')">
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="text-center pt-lg-md">
                    <h2 class="heading h1 mb-2">
                        来都来了 <span class="breathing-effect">o</span>(￣ヘ￣*o)
                    </h2>
                </div>
            </div>
        </div>
        <div class="container-fluid" style="justify-content: center;display: flex;">
            <div class="col-lg-7">
                <div class="row" style="justify-content: space-between;">
                    <div class="heading h3 mb-2">
                        <div class="comment-open-button" type="button" data-toggle="modal" data-target="#commentModal"
                             style="width: 4rem">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                 class="bi bi-envelope-plus" viewBox="0 0 16 16">
                                <path d="M2 2a2 2 0 0 0-2 2v8.01A2 2 0 0 0 2 14h5.5a.5.5 0 0 0 0-1H2a1 1 0 0 1-.966-.741l5.64-3.471L8 9.583l7-4.2V8.5a.5.5 0 0 0 1 0V4a2 2 0 0 0-2-2H2Zm3.708 6.208L1 11.105V5.383l4.708 2.825ZM1 4.217V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.217l-7 4.2-7-4.2Z"/>
                                <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-3.5-2a.5.5 0 0 0-.5.5v1h-1a.5.5 0 0 0 0 1h1v1a.5.5 0 0 0 1 0v-1h1a.5.5 0 0 0 0-1h-1v-1a.5.5 0 0 0-.5-.5Z"/>
                            </svg>
                        </div>
                    </div>
                    <!-- 评论列表表头部分，加入分页组件 -->
                    <nav aria-label="Page navigation" class="d-flex justify-content-between align-items-center">
                        <ul class="pagination justify-content-end" id="pagination">
                            <!-- 分页按钮将通过 JavaScript 动态生成 -->
                        </ul>
                    </nav>
                </div>
                <div id="friend-comment" class="list-group align-items-center">


                </div>
            </div>
        </div>
    </section>
    <!-- 模态框结构 -->
    <div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="commentModalLabel">留言板(审核后展示)</h5>
                    <h6 class="modal-title">用户等级3级后免审核</h6>
                    <div class="form-check form-switch" style="margin-right: 1.5rem;">
                        <input class="form-check-input" type="checkbox" id="anonymousSwitch"
                               onclick="toggleAnonymousFields()">
                        <label class="form-check-label" for="anonymousSwitch">匿名留言</label>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- 原始表单内容 -->
                    <form id="commentForm">
                        <div class="form-group">
                                    <textarea class="form-control" rows="5" placeholder="留言内容" name="comment"
                                              required></textarea>
                        </div>
                        <div class="commentSendBtn">
                            <button type="submit" class="btn" style="font-size: 2rem;background-color: #f0f8ff00;padding:0">
                                <i class="bi bi-send-check"></i>
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- 模态框结构 -->
    <div class="modal fade" id="commentReplyModal" tabindex="-1" role="dialog" aria-labelledby="commentReplyModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="commentReplyModalLabel">回复: <span id="replyUsername"></span>(审核后展示)</h5>
                    <h6 class="modal-title">用户等级3级后免审核</h6>
                </div>
                <div class="modal-body">
                    <!-- 原始表单内容 -->
                    <form>
                        <div class="form-group">
                                    <textarea id="replyText" class="form-control" rows="5" placeholder="留言内容" name="comment"
                                              required></textarea>
                        </div>
                        <div class="commentSendBtn">
                            <div onclick="replayComment()" class="btn" style="font-size: 2rem;background-color: #f0f8ff00;padding:0">
                                <i class="bi bi-send-check"></i>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</main>

<!-- 模态框，用于显示评论详情 -->
<div class="modal fade" id="commentDetailModal" tabindex="-1" aria-labelledby="commentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="top: 4rem;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentDetailModalLabel">评论详情</h5>
            </div>
            <div class="modal-body">
                <p id="modal-comment-content"></p>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!-- 页面底部 -->
<div id="footer"></div>
<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>

<script>
    // 初始页面与页面大小
    let currentPage = 1;
    const pageSize = 5; // 每页显示5条评论
    let currentReplyCommentId;
    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        $('#footer').load("../pages/footer.html", insertCreateTime);
        // 页面加载时，默认加载第一页
        fetchComments(currentPage);

        // 显示评论详情模态框
        window.showCommentDetails = function(comment) {
            const modalCommentContent = document.getElementById("modal-comment-content");
            modalCommentContent.textContent = decodeURIComponent(comment);
            const commentDetail = new bootstrap.Modal(document.getElementById('commentDetailModal'));
            commentDetail.show();
        };
    };

    const maxCommentLength = 100; // 评论显示最大长度

    function fetchComments(page) {
        const mainPageImageFlow = new XMLHttpRequest();

        // 创建加载动画元素
        const loadingOverlay = document.createElement("div");
        loadingOverlay.className = "loading-overlay";
        loadingOverlay.innerHTML = `<div class="loading-spinner"></div>`;
        document.body.appendChild(loadingOverlay);

        // 请求评论接口，加入分页参数
        mainPageImageFlow.open("GET", `/base/anakki/friends-comment/list-comments?current=${page}&size=${pageSize}`, true);
        mainPageImageFlow.onreadystatechange = function () {
            if (mainPageImageFlow.readyState === 4 && mainPageImageFlow.status === 200) {
                // 移除加载动画
                document.body.removeChild(loadingOverlay);

                const response = JSON.parse(mainPageImageFlow.responseText);
                const itemList = response.data.data;
                const totalItems = response.data.totalNum; // 后端返回的总条数
                const totalPages = Math.ceil(totalItems / pageSize); // 计算总页数

                let html = "";
                let index=0;
                for (let i = 0; i < itemList.length; i++) {
                    index+=200;
                    const item = itemList[i];
                    let time = item.createTime;
                    let nicknameColor = item.nicknameColor;
                    if (!nicknameColor){
                        nicknameColor= "aqua";
                    }
                    const formattedDateTime = time.replace("T", " ");
                    const targetDate = new Date(time);
                    const currentDate = new Date();
                    const timeDiff = currentDate.getTime() - targetDate.getTime();
                    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    let daysBefore = (daysDiff === 0) ? "今天" : daysDiff + "天以前";

                    // 检查评论长度是否超出
                    const truncatedComment = item.comment.length > maxCommentLength
                        ? item.comment.substring(0, maxCommentLength) + "..."
                        : item.comment;

                    // 显示评论内容，如果内容超出显示“查看更多”
                    html += `
                        <div class="card mb-3 comment-card div-trans-${index}">
                            <div class="d-flex align-items-start">
                                <img src="${item.avatar ? item.avatar : '../assets/images/default-avatar.jpg'}" class="rounded-circle avatar-size" alt="avatar">
                                <div class="ms-3 w-100" style="margin: 0.5rem;">
                                    <div class="d-flex justify-content-between">
                                        <h5 class="card-title mb-1" style="color: ${nicknameColor}">${item.nickname}</h5>
                                        <p class="card-time text-muted mb-0">${daysBefore}-${formattedDateTime}</p>
                                    </div>
                                    <p class="card-text">${truncatedComment}</p>
                                    ${item.comment.length > maxCommentLength ? `<a href="javascript:void(0);" onclick="showCommentDetails('${encodeURIComponent(item.comment)}')">查看更多</a>` : ''}
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <a href="#" onclick="likeComment(${item.id})"><i class="bi bi-suit-heart">${item.likeCount}</i></a>
                                        <a type="button" data-toggle="modal" data-target="#commentReplyModal" onclick="openReplyModel(${item.id},'${item.nickname}')">
                                            <i class="bi bi-chat-right-dots" style="color: cyan;"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                document.getElementById("friend-comment").innerHTML = html;
                renderPagination(totalPages, page); // 渲染分页按钮
            }
        };
        mainPageImageFlow.send();
    }
    function renderPagination(totalPages, currentPage) {
        const pagination = document.getElementById('pagination');
        let paginationHtml = '';

        // 上一页按钮
        if (currentPage > 1) {
            paginationHtml += `<li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="fetchComments(${currentPage - 1})">
                                    <i class="bi bi-caret-left-fill"></i>
                                    </a>
                               </li>`;
        }

        // 页码按钮
        for (let page = 1; page <= totalPages; page++) {
            paginationHtml += `<li class="page-item ${page === currentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="fetchComments(${page})">${page}</a>
                </li>`;
        }

        // 下一页按钮
        if (currentPage < totalPages) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="fetchComments(${currentPage + 1})">
                                    <i class="bi bi-caret-right-fill"></i>
                                </a></li>`;
        }

        pagination.innerHTML = paginationHtml;
    }



    $(document).ready(function () {
        $('#commentForm').submit(function (e) {
            e.preventDefault(); // Prevent form submission

            const formDataArray = $(this).serializeArray(); // Serialize form data to array
            let token = localStorage.getItem('user-token');
            // 获取匿名留言开关的状态
            const isAnonymous = $('#anonymousSwitch').is(':checked');
            let base = "/base";
            if (!isAnonymous) {
                base = "/api";
            }
            if (!isAnonymous && null == token) {
                alert("请登录，游客仅支持匿名评论")
                return
            }

            // 将匿名留言状态添加到表单数据中
            formDataArray.push({name: 'isAnonymous', value: isAnonymous});

            // 将表单数据数组转换为对象
            var formData = {};
            $.each(formDataArray, function (i, field) {
                formData[field.name] = field.value;
            });

            $.ajax({
                url: base + '/anakki/friends-comment/create-comment',
                type: 'POST',
                data: formData, // 直接传递对象形式的数据
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('authorization', localStorage.getItem('user-token')); // Include the token in the Authorization header
                },
                success: function (response) {
                    if (response.code === 200) {
                        alert("发送成功~！")
                        location.reload();
                    } else {
                        alert("系统错误，请联系管理员！")
                    }
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    console.log(error);
                    alert("系统错误，请联系管理员！")
                }
            });
        });
    });

    function openReplyModel(id,nickname){
        currentReplyCommentId=id;
        document.getElementById('replyUsername').innerText=nickname;
    }
    function replayComment(){
        let token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录");
            return
        }
        // 获取 textarea 的内容
        const replyText = document.getElementById('replyText').value;
        if (!replyText){
            return;
        }
        $.ajax({
            url:  '/api/anakki/friends-comment/reply-comment',
            type: 'POST',
            contentType: 'application/json', // 设置请求类型为 JSON
            data: JSON.stringify({ // 将数据转换为 JSON 字符串
                commentId: currentReplyCommentId,
                comment: replyText,
            }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('authorization',token); // Include the token in the Authorization header
            },
            success: function (response) {
                if (response.code === 200) {
                    alert("回复成功~！",()=>{location.reload()})
                } else {
                    alert(response.data)
                }
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.log(error);
                alert(error.data)
            }
        });
    }

    function likeComment(id){
        let token = localStorage.getItem('user-token');

        let baseUrl="/base";
        if (token){
            baseUrl="/api"
        }

        $.ajax({
            url:  baseUrl+'/anakki/friends-comment/like',
            type: 'POST',
            contentType: 'application/json', // 设置请求类型为 JSON
            data: JSON.stringify({ // 将数据转换为 JSON 字符串
                commentId: id,
            }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('authorization', ); // Include the token in the Authorization header
            },
            success: function (response) {
                if (response.code === 200) {
                } else {
                    alert("系统错误，请联系管理员！")
                }
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.log(error);
                alert("系统错误，请联系管理员！")
            }
        });
    }
    function toggleAnonymousFields() {
        const nicknameInput = document.getElementById('nicknameInput');
        const emailInput = document.getElementById('emailInput');
        const displayStyle = nicknameInput.style.display === 'none' ? 'block' : 'none';
        nicknameInput.style.display = displayStyle;
        emailInput.style.display = displayStyle;
    }
</script>
</body>
</html>
