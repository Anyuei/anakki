<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。                             ">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->
    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta
            content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
            name="viewport"
    />
    <style>
        .bg-tertiary {
            background-color: #503662 !important;
        }
    </style>
    <script src="../assets/js/ckeditor5-41.4.2-ij2a3vhv6e7y/build/translations/zh-cn.js"></script>
    <script src="../assets/js/ckeditor5-41.4.2-ij2a3vhv6e7y/build/ckeditor.js"></script>
</head>
<style>
    .center-video {
        text-align: center;
    }

    .bg-light {
        position: relative;
    }

    .date {
        position: absolute;
        bottom: 0;
        right: 0;
        margin: 10px;
        font-size: 14px;
        color: #666;
    }

    .publish-area {
        width: 100%;
        height: 4rem;
        bottom: 0;
        background: #7e7e7e;
        display: flex;
        justify-content: center;
        z-index: 9999;
    }


    .content-area {
        height: auto;
        width: 100%;
        background: #77777787;
        margin-top: 2rem;
        border-radius: 10px;
        padding: 8px 16px;
    }

    .button-container {
        margin: 10px 10px; /* Optional margin between buttons */
    }

    .btn {
        height: 40px;
        padding: 8px 16px;
        font-size: 16px;
        color: #fff;
        border: none;
        white-space: nowrap;
        background: #18595970;
    }

    .note-node-cover {
        padding-right: 0px;
        padding-left: 0px;
    }

    .cover-img {
        width: 100%;
        border-radius: 10px 0px 0px 10px;
    }

    .note-node-title {
        font-weight: bold;
        margin-top: 0.5rem;
    }

    #toggleButton {
        background: #95959500;
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.33);
    }

    .note-node {
        border-radius: 10px;
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.34);
    }

    #toggleButton:hover {
        background: rgba(149, 149, 149, 0.27);
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.34);
    }

    body {
        color: #2f2f2f;
        background-color: #000000b5;
    }

    .col-md-4 {
        padding-right: 0px;
        padding-left: 0px;
    }

    .draftList{

    }
    #adContent {
        width: 800px; /* Set the width of the editor */
        height: 400px; /* Set the height of the editor */
    }
    .form-group {
        margin-bottom: 0rem;
    }
    textarea {
        width: 80%;
        height: 80vh;
    }
</style>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <div class="container" style="margin-top: 4rem;">
        <div class="input-group mb-3 mt-1">
            <input id="searchInputText" type="text" class="form-control" placeholder="全局搜索"
                   aria-label="全局搜索" aria-describedby="button-addon2">
            <button class="btn search-button" type="button" id="button-addon2" onclick="searchButton()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search"
                     viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
            </button>
        </div>
        <div class="row">
            <!--      打开笔记按钮      -->
            <div class="col-md-4">
                <button id="listNoteButton" class="btn" style="width: 100%;height: 3rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-files" viewBox="0 0 16 16">
                        <path d="M13 0H6a2 2 0 0 0-2 2 2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 13V4a2 2 0 0 0-2-2H5a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1zM3 4a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4z"/>
                    </svg>
                </button>
            </div>
            <!--      打开草稿列表按钮      -->
            <div class="col-md-4">
                <button id="listDraftButton" class="btn" style="width: 100%;height: 3rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-ui-checks" viewBox="0 0 16 16">
                        <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708l-2 2zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708l-2 2zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
            </div>
            <!--      编辑新笔记按钮      -->
            <div class="col-md-4">
                <button id="editDraftButton" class="btn" style="width: 100%;height: 3rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                         class="bi bi-plus-circle-dotted" viewBox="0 0 16 16">
                        <path d="M8 0c-.176 0-.35.006-.523.017l.064.998a7.117 7.117 0 0 1 .918 0l.064-.998A8.113 8.113 0 0 0 8 0zM6.44.152c-.346.069-.684.16-1.012.27l.321.948c.287-.098.582-.177.884-.237L6.44.153zm4.132.271a7.946 7.946 0 0 0-1.011-.27l-.194.98c.302.06.597.14.884.237l.321-.947zm1.873.925a8 8 0 0 0-.906-.524l-.443.896c.275.136.54.29.793.459l.556-.831zM4.46.824c-.314.155-.616.33-.905.524l.556.83a7.07 7.07 0 0 1 .793-.458L4.46.824zM2.725 1.985c-.262.23-.51.478-.74.74l.752.66c.202-.23.418-.446.648-.648l-.66-.752zm11.29.74a8.058 8.058 0 0 0-.74-.74l-.66.752c.23.202.447.418.648.648l.752-.66zm1.161 1.735a7.98 7.98 0 0 0-.524-.905l-.83.556c.169.253.322.518.458.793l.896-.443zM1.348 3.555c-.194.289-.37.591-.524.906l.896.443c.136-.275.29-.54.459-.793l-.831-.556zM.423 5.428a7.945 7.945 0 0 0-.27 1.011l.98.194c.06-.302.14-.597.237-.884l-.947-.321zM15.848 6.44a7.943 7.943 0 0 0-.27-1.012l-.948.321c.098.287.177.582.237.884l.98-.194zM.017 7.477a8.113 8.113 0 0 0 0 1.046l.998-.064a7.117 7.117 0 0 1 0-.918l-.998-.064zM16 8a8.1 8.1 0 0 0-.017-.523l-.998.064a7.11 7.11 0 0 1 0 .918l.998.064A8.1 8.1 0 0 0 16 8zM.152 9.56c.069.346.16.684.27 1.012l.948-.321a6.944 6.944 0 0 1-.237-.884l-.98.194zm15.425 1.012c.112-.328.202-.666.27-1.011l-.98-.194c-.06.302-.14.597-.237.884l.947.321zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a6.999 6.999 0 0 1-.458-.793l-.896.443zm13.828.905c.194-.289.37-.591.524-.906l-.896-.443c-.136.275-.29.54-.459.793l.831.556zm-12.667.83c.23.262.478.51.74.74l.66-.752a7.047 7.047 0 0 1-.648-.648l-.752.66zm11.29.74c.262-.23.51-.478.74-.74l-.752-.66c-.201.23-.418.447-.648.648l.66.752zm-1.735 1.161c.314-.155.616-.33.905-.524l-.556-.83a7.07 7.07 0 0 1-.793.458l.443.896zm-7.985-.524c.289.194.591.37.906.524l.443-.896a6.998 6.998 0 0 1-.793-.459l-.556.831zm1.873.925c.328.112.666.202 1.011.27l.194-.98a6.953 6.953 0 0 1-.884-.237l-.321.947zm4.132.271a7.944 7.944 0 0 0 1.012-.27l-.321-.948a6.954 6.954 0 0 1-.884.237l.194.98zm-2.083.135a8.1 8.1 0 0 0 1.046 0l-.064-.998a7.11 7.11 0 0 1-.918 0l-.064.998zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!--        笔记列表-->
        <div class="noteList" id="noteList" style="margin-top: 1rem;">

        </div>
        <!--        草稿列表-->
        <div class="draftList" id="draftList" style="margin-top: 1rem;display: none;">

        </div>
        <!--        笔记编辑区域-->
        <div class="bg-light mt-4 rounded" id="createDraft" style="display: none;">
            <form id="thisForm" class="form-horizontal">
                <div class="form-group">
                    <div class="col-xs-12">
                            <textarea id="adContent" oninput="scrollToBottom()">

                            </textarea>
                    </div>
                </div>
            </form>
            <div class="publish-area" id="publish-area">
                <div class="button-container" onclick="saveDraft()">
                    <button class="btn">
                        保存草稿
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                            <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
                        </svg>
                    </button>
                </div>
                <div class="button-container" onclick="publish()">
                    <button class="btn">
                        发布
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send"
                             viewBox="6 -4 5 17">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>


<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>
<script>
    let thisAdEditor;
    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        listNotes(1, 10);
    }
    // 初始化内容富文本
    $(function () {
        ClassicEditor
            .create(document.querySelector("#adContent"), {
                language: 'zh-cn',													// 中文
                extraPlugins: [MyCustomUploadAdapterPlugin], 						// 参考官方文档自定义Adapter实现图片上传
                mediaEmbed: {														// 提供视频上传支持
                    previewsInData: true,
                    providers: [
                        {
                            name: 'mediaUpload',
                            url: [],
                            html: match => {
                                //获取媒体url
                                const input = match['input'];
                                return (
                                    '<div style="position: relative; padding-bottom: 100%; height: 0; padding-bottom: 56.2493%;">' +
                                    `<iframe src="http://${input}" ` +
                                    'style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;" ' +
                                    'frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>' +
                                    '</iframe>' +
                                    '</div>'
                                );
                            }
                        }
                    ]
                }
            })
            .then(editor => {
                thisAdEditor = editor;
            })
            .catch(error => {
                console.error(error);
            });
    });
    function scrollToBottom() {
        var textarea = document.getElementById('adContent');
        textarea.scrollTop = textarea.scrollHeight - textarea.clientHeight;
    }
    function saveDraft() {
        const data = thisAdEditor.getData()

        const token = localStorage.getItem('user-token'); // Get the JWT token from localStorage
        // Make an AJAX POST request
        fetch('/api/anakki/an-note-draft/saveNoteDraft', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify({content: data}),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    const noteId = data.data.data;
                    localStorage.setItem('noteId', noteId);
                    alert("保存成功")
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function publish() {
        const data = thisAdEditor.getData()

        const token = localStorage.getItem('user-token'); // Get the JWT token from localStorage
        // Make an AJAX POST request
        fetch('/api/anakki/note/createNote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify(
                {
                    content: data,
                    isDraft: true
                }
            ),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    const noteId = data.data.data;
                    localStorage.setItem('noteId', noteId);
                    alert("发布成功")
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    function searchButton() {
        const input = document.getElementById("searchInputText").value;
        listNotes(1, 5, input);
    }
    function listNotes(current, pageSize, searchInput) {
        if (null == searchInput || "" === searchInput) {
            searchInput = "";
        } else {
            searchInput = "&content=" + searchInput;
        }
        const token = localStorage.getItem('user-token'); // Get the JWT token from localStorage
        // Make an AJAX POST request
        fetch('/base/anakki/note/listNote?' + current + "&size=" + pageSize + searchInput, {
            method: 'GET',
            headers: {
                'authorization': token
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                const itemList = data.data.data;
                let html = "";
                for (let i = 0; i < itemList.length; i++) {
                    const item = itemList[i];

                    let coverImgHtml="";
                    if (null!=item.coverImage){
                        coverImgHtml=
                            "                <div class=\"note-node-cover col-2\">\n" +
                            "                    <img class=\"cover-img\"\n" +
                            "                         src="+item.coverImage+"></div>"
                    }

                    html +=
                        "<span class=\"note-node row\">\n" +
                        coverImgHtml+
                        "                <div class=\"note-node-content col-10\">\n" +
                        "                    <div class=\"note-node-title\">\n" +
                        "                        <h4>"+item.title+"</h4>\n" +
                        "                    </div>\n" +
                        "                    <div class=\"note-node-description\">"+item.description+"</div>\n" +
                        "                </div>\n" +
                        "            </span>"; // Construct HTML content for each item
                }
                document.getElementById("noteList").innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    ClassicEditor
        .create(document.querySelector('#editor'))
        .catch(error => {
            console.error(error);
        });

    class MyUploadAdapter {
        constructor(loader) {
            // 上载期间要使用的文件加载器实例
            this.loader = loader;
        }

        // 启动上传过程
        upload() {
            return this.loader.file
                .then(file => new Promise((resolve, reject) => {
                    this._initRequest();
                    this._initListeners(resolve, reject, file);
                    this._sendRequest(file);
                }));
        }

        // 中止上传过程
        abort() {
            if (this.xhr) {
                this.xhr.abort();
            }
        }

        // 初始化 XMLHttpRequest 对象使用URL传递给构造函数
        _initRequest() {
            const xhr = this.xhr = new XMLHttpRequest();
            // *使用JSON作为数据结构的POST请求,url根据实际情况配置
            xhr.open('POST', '/api/anakki/note/uploadFiles', true);
            xhr.responseType = 'json';
        }

        // 初始化XMLHttpRequest监听器
        _initListeners(resolve, reject, file) {
            const xhr = this.xhr;
            const loader = this.loader;
            const genericErrorText = `无法上传文件: ${file.name}.`;

            xhr.addEventListener('error', () => reject(genericErrorText));
            xhr.addEventListener('abort', () => reject());
            xhr.addEventListener('load', () => {
                const response = xhr.response;
                if (response.code === 101) {
                    alert(response.data)
                } else {
                    // 上传成功的处理
                    resolve({
                        default: response.data
                    });
                }
            });

            // 编辑器用户界面中显示上传进度条
            if (xhr.upload) {
                xhr.upload.addEventListener('progress', evt => {
                    if (evt.lengthComputable) {
                        loader.uploadTotal = evt.total;
                        loader.uploaded = evt.loaded;
                    }
                });
            }
        }

        // 准备数据并发送请求
        _sendRequest(file) {
            // 准备表单数据
            const data = new FormData();
            data.append('uploadFiles', file);
            // 实现认证和CSRF保护等安全机制
            this.xhr.setRequestHeader('authorization', localStorage.getItem('user-token'));
            // 发送请求.
            this.xhr.send(data);
        }
    }

    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
            // 配置上传脚本的后端URL
            return new MyUploadAdapter(loader);
        };
    }

    const noteListDiv = document.getElementById('noteList');
    const listNoteButton = document.getElementById('listNoteButton');

    const draftListDiv = document.getElementById('draftList');
    const listDraftButton = document.getElementById('listDraftButton');

    const createDraftDiv = document.getElementById('createDraft');
    const editDraftButton = document.getElementById('editDraftButton');
    listNoteButton.addEventListener('click', function () {
        if (noteListDiv.style.display === 'none') {
            noteListDiv.style.display = 'block';
            createDraftDiv.style.display = 'none';
            draftListDiv.style.display = 'none';
            document.getElementById('publish-area').style.display= 'none';
            listNotes(1, 10);
        }
    });
    listDraftButton.addEventListener('click', function () {
        if (draftListDiv.style.display === 'none') {
            draftListDiv.style.display = 'block';
            noteListDiv.style.display = 'none';
            createDraftDiv.style.display = 'none';
            document.getElementById('publish-area').style.display= 'none';
        }
    });
    editDraftButton.addEventListener('click', function () {
        if (createDraftDiv.style.display === 'none') {
            createDraftDiv.style.display = 'block';
            document.getElementById('publish-area').style.display= '';
            noteListDiv.style.display = 'none';
            draftListDiv.style.display = 'none';
        }
    });


</script>
</body>
</html>