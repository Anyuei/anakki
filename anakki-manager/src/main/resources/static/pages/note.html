<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。                             ">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta
            content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
            name="viewport"
    />
    <style>
        .bg-tertiary {
            background-color: #503662 !important;
        }
    </style>
    <script src="../assets/js/ckeditor5-41.4.2-ij2a3vhv6e7y/build/translations/zh-cn.js"></script>
    <script src="../assets/js/ckeditor5-41.4.2-ij2a3vhv6e7y/build/ckeditor.js"></script>
</head>
<style>
    .center-video {
        text-align: center;
    }

    .bg-light {
        position: relative;
    }

    .date {
        position: absolute;
        bottom: 0;
        right: 0;
        margin: 10px;
        font-size: 14px;
        color: #666;
    }

    .publish-area {
        width: 100%;
        height: 4rem;
        bottom: 0;
        background: #7e7e7e;
        display: flex;
        justify-content: center;
        z-index: 9999;
    }


    .content-area {
        height: auto;
        width: 100%;
        background: #77777787;
        margin-top: 2rem;
        border-radius: 10px;
        padding: 8px 16px;
    }

    .button-container {
        margin: 10px 10px; /* Optional margin between buttons */
    }

    .btn {
        height: 40px;
        padding: 8px 16px;
        font-size: 16px;
        color: #fff;
        border: none;
        white-space: nowrap;
        background: #18595970;
    }

    .note-node-cover {
        padding-right: 0px;
        padding-left: 0px;
    }

    .cover-img {
        width: 100%;
        border-radius: 10px 0px 0px 10px;
    }

    .note-node-title {
        font-weight: bold;
        margin-top: 0.5rem;
        display: flex; /* 使用Flexbox布局 */
        justify-content: space-between; /* 两端对齐子元素 */
    }
    .note-node-content {
        margin-bottom: 1.5rem;
        transition: all 0.3s ease; /* 添加平滑过渡效果 */
    }

    .note-node-content:hover {
        margin-bottom: 1.5rem;
        background-color: #28282845;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.18);
        transform: translateY(-5px);
    }
    #toggleButton {
        background: #95959500;
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.33);
    }

    .note-node {
        border-radius: 10px;
        box-shadow: 0 4px 15px 10px rgba(0, 0, 0, 0.34);
        background-color: #20202078;
        color: #a0a0a0;
    }

    #toggleButton:hover {
        background: rgba(149, 149, 149, 0.27);
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.34);
    }

    body {
        color: #2f2f2f;
        background-color: rgb(143, 61, 61);
        transition: background-color 0.5s ease;
    }

    .col-md-4 {
        padding-right: 0px;
        padding-left: 0px;
    }

    .draftList{

    }
    #adContent {
        width: 800px; /* Set the width of the editor */
        height: 400px; /* Set the height of the editor */
    }
    .form-group {
        margin-bottom: 0rem;
    }
    textarea {
        width: 80%;
    }
    .dropdown-menu .dropdown-item > i, .dropdown-menu .dropdown-item > svg {
        margin-right: 0rem;
        font-size: 1rem;
        vertical-align: -17%;
    }
    .dropdown-menu {
        min-width: 3rem;
    }
    .modal-dialog {
        max-width: 999px;
        margin: 1.75rem auto;
    }
    .note-node-time {
        text-align: right;
        padding: 0rem 0rem 0.5rem 0rem;
    }
    h4{
        color: #fff;
    }
    .ck-editor__editable { min-height: 400px; }

    .breathing-icon {
        animation: breathe 2s infinite alternate;
    }

    @keyframes breathe {
        0% { transform: scale(1); }
        100% { transform: scale(1.1); }
    }

    .modal-header {
        display: flex;
        margin: 0.5rem 1rem;
    }
    .modal-content {
        background-color: #e6e6e6;
    }
    .note-node-title-dropdown-icon{
        margin-top: 0.5rem;
        font-size: 1.3rem;
        cursor: pointer;
    }

    .author-item .author-avatar{
        height: 2rem;
        width: 2rem;
        border-radius: 1rem;
    }
    #viewModalNoteAuthors{
        width: 30%;
        display: flex;
    }

    #viewModalNoteAuthorsForEditor{
        left: 1rem;
        position: absolute;
    }

    #editor-area{
        display: flex;
        padding: 1rem;
        position: absolute;
        left: 0;
    }

    .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 1rem;
        border-top: 1px solid #e9ecef;
    }
    .color-picker {
        margin: 20px;
    }
    .note-group {
        height: 2.5rem;
        background-color: #6f2020c9;
        margin-bottom: 0.4rem;
        border-radius: 0.6rem;
        box-shadow: 0 4px 15px 10px rgba(0, 0, 0, 0.34);
        align-content: center;
        justify-items: center;
        color: #d9d9d9;
        font-size: unset;
        transition: all 0.3s ease;
    }
    .note-group:hover {
        cursor: pointer;
        background-color: #28282845;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.18);
        transform: translateY(-5px);
    }

    .editor-select-for-note{
        justify-content: space-between;
        display: flex;
        padding: 0.5rem 0.5rem;
    }
    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }

    .userListSearchArea{
        justify-content: space-between;
        display: flex;
    }

    .note-group.active{
        cursor: pointer;
        background-color: #28282845;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.18);
        transform: translateY(-5px);
    }
</style>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <div class="container" style="margin-top: 4rem;">

        <div id="loading-overlay" class="loading-overlay" style="display:none;">
            <div class="loading-spinner"></div>
        </div>
        <div class="color-picker">
            <label for="color" style="font-size: 1.5rem;"><i class="bi bi-paint-bucket"></i></label>
            <input type="color" id="color" name="color" value="#ffffff">
        </div>



        <div class="row">
            <div class="col-2" id="viewNoteGroup">

            </div>
            <div class="col-10">
                <div class="row">
                    <!--      打开笔记按钮      -->
                    <div class="col-6" style="padding-right: 5px;padding-left: 0px;">
                        <div class="input-group">
                            <input id="searchInputText" type="text" class="form-control" placeholder="全局搜索"
                                   aria-label="全局搜索" aria-describedby="search-note-button">
                            <button class="btn search-button" type="button" id="search-note-button" onclick="searchButton()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search"
                                     viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                                <span id="buttonSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                            </button>

                        </div>
                    </div>
                    <!--      打开笔记按钮      -->
                    <div class="col-2" style="padding-right: 5px;padding-left: 5px;">
                        <button onclick="showNotesButton()" id="listNoteButton" class="btn" style="width: 100%;height: 2.5rem;">
                            <i class="bi bi-journals"></i>
                        </button>
                    </div>
                    <!--      打开草稿列表按钮      -->
                    <div class="col-2" style="padding-right: 5px;padding-left: 5px;">
                        <button onclick="showDraftNotesButton()" id="listDraftButton" class="btn" style="width: 100%;height: 2.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-ui-checks" viewBox="0 0 16 16">
                                <path d="M7 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zM2 1a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2zm0 8a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H2zm.854-3.646a.5.5 0 0 1-.708 0l-1-1a.5.5 0 1 1 .708-.708l.646.647 1.646-1.647a.5.5 0 1 1 .708.708l-2 2zm0 8a.5.5 0 0 1-.708 0l-1-1a.5.5 0 0 1 .708-.708l.646.647 1.646-1.647a.5.5 0 0 1 .708.708l-2 2zM7 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-1zm0-5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                    <!--      编辑新笔记按钮      -->
                    <div class="col-2" style="padding-right: 0px;padding-left: 5px;">
                        <button onclick="showEditDraftNoteButton()" id="editDraftButton" class="btn" style="width: 100%;height: 2.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-plus-circle-dotted" viewBox="0 0 16 16">
                                <path d="M8 0c-.176 0-.35.006-.523.017l.064.998a7.117 7.117 0 0 1 .918 0l.064-.998A8.113 8.113 0 0 0 8 0zM6.44.152c-.346.069-.684.16-1.012.27l.321.948c.287-.098.582-.177.884-.237L6.44.153zm4.132.271a7.946 7.946 0 0 0-1.011-.27l-.194.98c.302.06.597.14.884.237l.321-.947zm1.873.925a8 8 0 0 0-.906-.524l-.443.896c.275.136.54.29.793.459l.556-.831zM4.46.824c-.314.155-.616.33-.905.524l.556.83a7.07 7.07 0 0 1 .793-.458L4.46.824zM2.725 1.985c-.262.23-.51.478-.74.74l.752.66c.202-.23.418-.446.648-.648l-.66-.752zm11.29.74a8.058 8.058 0 0 0-.74-.74l-.66.752c.23.202.447.418.648.648l.752-.66zm1.161 1.735a7.98 7.98 0 0 0-.524-.905l-.83.556c.169.253.322.518.458.793l.896-.443zM1.348 3.555c-.194.289-.37.591-.524.906l.896.443c.136-.275.29-.54.459-.793l-.831-.556zM.423 5.428a7.945 7.945 0 0 0-.27 1.011l.98.194c.06-.302.14-.597.237-.884l-.947-.321zM15.848 6.44a7.943 7.943 0 0 0-.27-1.012l-.948.321c.098.287.177.582.237.884l.98-.194zM.017 7.477a8.113 8.113 0 0 0 0 1.046l.998-.064a7.117 7.117 0 0 1 0-.918l-.998-.064zM16 8a8.1 8.1 0 0 0-.017-.523l-.998.064a7.11 7.11 0 0 1 0 .918l.998.064A8.1 8.1 0 0 0 16 8zM.152 9.56c.069.346.16.684.27 1.012l.948-.321a6.944 6.944 0 0 1-.237-.884l-.98.194zm15.425 1.012c.112-.328.202-.666.27-1.011l-.98-.194c-.06.302-.14.597-.237.884l.947.321zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a6.999 6.999 0 0 1-.458-.793l-.896.443zm13.828.905c.194-.289.37-.591.524-.906l-.896-.443c-.136.275-.29.54-.459.793l.831.556zm-12.667.83c.23.262.478.51.74.74l.66-.752a7.047 7.047 0 0 1-.648-.648l-.752.66zm11.29.74c.262-.23.51-.478.74-.74l-.752-.66c-.201.23-.418.447-.648.648l.66.752zm-1.735 1.161c.314-.155.616-.33.905-.524l-.556-.83a7.07 7.07 0 0 1-.793.458l.443.896zm-7.985-.524c.289.194.591.37.906.524l.443-.896a6.998 6.998 0 0 1-.793-.459l-.556.831zm1.873.925c.328.112.666.202 1.011.27l.194-.98a6.953 6.953 0 0 1-.884-.237l-.321.947zm4.132.271a7.944 7.944 0 0 0 1.012-.27l-.321-.948a6.954 6.954 0 0 1-.884.237l.194.98zm-2.083.135a8.1 8.1 0 0 0 1.046 0l-.064-.998a7.11 7.11 0 0 1-.918 0l-.064.998zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!--        笔记列表-->
                <div class="noteList " id="noteList" style="margin-top: 1rem;display: block;">

                </div>
                <!--        草稿列表-->
                <div class="draftList" id="draftList" style="margin-top: 1rem;display: none;">

                </div>
                <!--        笔记编辑区域-->
                <div class="bg-light mt-4 rounded" id="createDraft" style="display: none;">
                    <form id="thisForm" class="form-horizontal">
                        <div class="form-group">
                            <div class="col-xs-12">
                                <div id="noteId" style="display:none;"></div>
                                <textarea id="adContent" oninput="scrollToBottom()">

                            </textarea>
                            </div>
                        </div>
                    </form>
                    <div class="publish-area" id="publish-area">
                        <!--    编辑者 区域-->
                        <div id="editor-area">
                            <div style="font-size: 1.2rem;margin-right: 0.5rem;">
                        <span>
                            <i class="bi bi-pencil"></i>
                        </span>
                            </div>
                            <div id="current-editors">


                            </div>
                            <div id="operate-editors">
                        <span id="addUserToNoteArea" style="font-size: 2rem;line-height: 30px;cursor: pointer;" onclick="listAuthorsAndUsersForNote()">
                            <i class="bi bi-plus-circle-dotted"></i>
                        </span>
                            </div>
                        </div>
                        <div class="button-container" onclick="saveDraft()">
                            <button class="btn">
                                保存草稿
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                          d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                                    <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="button-container" onclick="publish()">
                            <button class="btn">
                                发布
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send"
                                     viewBox="6 -4 5 17">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</main>



<!-- Add a modal to display the fetched data -->
<div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true" style="padding-right: 0 !important;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div style="display: none" id="noteDetailId"></div>
            <div class="modal-header" style="margin: 1rem 1rem 0rem 0rem;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Data fetched from backend will be displayed here -->
            </div>
            <div class="modal-footer justify-content-between">
                <div  id="viewModalNoteAuthors">


                </div>
                <div class="editor-operate-area">

                </div>
                <div id="foot-right">
                    <span  id="viewModalNoteTime" style="margin-right: 1rem;"></span> |
                    <span class="justify-content-between" style="margin-left: 1rem;" id="viewCountView">
                        <a href="#" onclick="likeNote()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 12">
                              <path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1z"/>
                            </svg>
                        </a>
                        <span id="noteLikeCount">
                        </span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 11">
                            <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                            <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                        </svg>
                        <span id="viewCount">
                        </span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add a modal to display the fetched data -->
<div class="modal fade" id="viewDraftModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true" style="padding-right: 0px;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="viewDraftModalBody">
                <!-- Data fetched from backend will be displayed here -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade"
     id="userModalForNoteEdit"
     tabindex="-1"
     role="dialog"
     aria-labelledby="userModalForNoteEditLabel"
     aria-hidden="true"
     style="padding-right: 0;">

    <div class="modal-dialog" role="document" style="max-width: 35rem;top: 3rem;">
        <div class="modal-content">
            <div class="row" style="justify-content: space-between">
                <div class="col-6 userListSearchArea">
                    <!-- 搜索框和查询按钮 -->
                    <input type="text" id="userSearchInput" class="form-control" placeholder="搜索用户" />
                    <button type="button" class="btn btn-primary" onclick="searchUserButton()" style="margin-left: 10px;">查询</button>
                </div>
                <div class="" style="align-content: center"><strong>协作者</strong></div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-right: 1rem;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="modal-body" style="padding: 0;">
                        <div id="userListContainer" style="height: 400px; overflow-y: auto;">
                            <div id="userListForNoteEdit" class="list-group"></div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="modal-body" style="padding: 0;">
                        <div id="authorListContainer" style="height: 400px; overflow-y: auto;">
                            <div id="authorListForNoteEdit" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="justify-content: space-between">
                <button type="button" class="btn btn-primary"  onclick="addAuthorToNotes()">加入协作</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary"  onclick="removeAuthorFromNotes()">移除协作</button>
            </div>
        </div>
    </div>

</div>

<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>
<script>
    let thisAdEditor;
    let editNoteId;
    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        viewNoteGroup()
        listNotes(1, 10);
    }
    window.addEventListener('beforeunload', function (e) {
        if (createDraftDiv.style.display === 'block') {
            // Cancel the event to prevent the browser from closing immediately
            e.preventDefault();
            // Chrome requires the event to be returned
            e.returnValue = '';
            // Display a confirmation message
            return '';
        }
    });

    // 背景调色
    const colorInput = document.getElementById('color');
    // Add an event listener to the color input element
    colorInput.addEventListener('input', function() {
        document.body.style.backgroundColor = colorInput.value;
    });

    // 初始化内容富文本
    $(function () {
        ClassicEditor
            .create(document.querySelector("#adContent"), {
                language: 'zh-cn',													// 中文
                extraPlugins: [MyCustomUploadAdapterPlugin], 						// 参考官方文档自定义Adapter实现图片上传
                mediaEmbed: {														// 提供视频上传支持
                    previewsInData: true,
                    providers: [
                        {
                            name: 'mediaUpload',
                            url: [],
                            html: match => {
                                //获取媒体url
                                const input = match['input'];
                                return (
                                    '<div style="position: relative; padding-bottom: 100%; height: 0; padding-bottom: 56.2493%;">' +
                                    `<iframe src="http://${input}" ` +
                                    'style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;" ' +
                                    'frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>' +
                                    '</iframe>' +
                                    '</div>'
                                );
                            }
                        }
                    ]
                }
            })
            .then(editor => {
                thisAdEditor = editor;
            })
            .catch(error => {
                console.error(error);
            });
    });

    function likeNote(){
        const noteId = document.getElementById("noteDetailId").innerHTML;
        if (noteId) {
            fetch('/base/anakki/note/likeNote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    {
                        id: noteId
                    }
                ),
            })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    incrNoteLikeCount()
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }
    function incrNoteLikeCount(){
        let likeCountElement = document.getElementById("noteLikeCount");
        let currentCount = parseInt(likeCountElement.innerHTML);
        likeCountElement.innerHTML = currentCount + 1;
    }
    function deleteNote(id) {
        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }

        document.getElementById('loading-overlay').style.display = 'flex';
        fetch('/api/anakki/note/deleteNote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify(
                {
                    id: id
                }
            ),
        })
        .then(response => {
            if (response.ok) {
                return response.json(); // Parse JSON data
            } else {
                // Handle error response
                console.error('网络错误，请联系管理员');
            }
        })
        .then(data => {
            document.getElementById('loading-overlay').style.display = 'none';
            if (data.code === 200) {
                document.getElementById("noteList").innerHTML='';
                currentViewNotePage=1
                listNotes(currentViewNotePage++, 10)
            } else {
                alert(data.data)
            }
        })
        .catch(error => {
            document.getElementById('loading-overlay').style.display = 'none';
            console.error('Error:', error);
        });
    }
    function deleteDraftNote(id) {
        const token = localStorage.getItem('user-token');
        fetch('/api/anakki/note/deleteNote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify(
                {
                    id: id
                }
            ),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    listDrafts(1, 10)
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function viewNoteGroup() {
        fetch('/base/anakki/an-note-group/list-note-group', {
            method: 'GET'
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    // 检查是否有分组
                    if (data.data && data.data.length > 0) {
                        // 遍历协作者信息并生成HTML内容
                        data.data.forEach(data => {
                            let html = `
                                <div class="row note-group" onclick="searchByGroupId(this, ${data.id})">
                                    <div class="col">
                                        <strong>${data.groupName}</strong>
                                         <strong>${data.noteCount}</strong>
                                    </div>
                                </div>
                            `;
                            document.getElementById("viewNoteGroup").insertAdjacentHTML('beforeend', html);
                        });
                    }
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function searchByGroupId(e,groupId){
        const noteGroups = document.querySelectorAll('.note-group');

        hasMoreNotes=true;
        document.getElementById("noteList").innerHTML = "";
        currentViewNotePage=1;
        // 为当前点击的 .note-group-onclick 添加 active 类
        // 判断当前元素是否已经有 active 类
        if (e.classList.contains('active')) {
            // 如果有 active 类，移除它并触发事件
            document.getElementById("searchInputText").placeholder = '全局搜索';
            e.classList.remove('active');
            groupUrl="";
            listNotes(currentViewNotePage++, 10);
        } else {
            document.getElementById("searchInputText").placeholder = '组内搜索';
            // 为每个 .note-group-onclick 添加点击事件
            noteGroups.forEach(noteGroup => {
                noteGroup.classList.remove('active');
            });
            // 如果没有 active 类，则添加 active 类
            e.classList.add('active');
            listNotes(currentViewNotePage++, 10, groupId);
        }
    }
    function viewNote(id) {
        fetch('/base/anakki/note/note-detail?id=' + id, {
            method: 'GET'
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    document.getElementById("viewModalBody").innerHTML = data.data.content;
                    document.getElementById("viewModalNoteTime").innerHTML = data.data.createTime.replace("T", " ");

                    let viewModalNoteAuthors = document.getElementById("viewModalNoteAuthors");

                    // 清空当前内容
                    viewModalNoteAuthors.innerHTML = '<span style="font-size: 2rem"><i class="bi bi-pen-fill"></i></span>';

                    // 检查是否有协作者
                    if (data.data.authorsDetail && data.data.authorsDetail.length > 0) {
                        // 遍历协作者信息并生成HTML内容
                        data.data.authorsDetail.forEach(author => {
                            let authorHTML = `
                                <span class="d-inline-block" style="align-content: center;" tabindex="0" data-toggle="tooltip" title="${author.nickname}">
                                    <div class="author-item">
                                        <img src="${author.avatar}" alt="${author.nickname}" class="author-avatar"/>
                                    </div>
                                </span>
                            `;
                            viewModalNoteAuthors.innerHTML += authorHTML;
                        });

                    }
                    viewModalNoteAuthors.innerHTML += '<span style="font-size: 2rem"><i class="bi bi-plus-circle-dotted"></i></span>';
                    // document.getElementById("viewModalNoteAuthor").innerHTML = data.data.author;
                    document.getElementById("viewCount").innerHTML = data.data.viewCount;
                    document.getElementById("noteLikeCount").innerHTML = data.data.likeCount;
                    document.getElementById("noteDetailId").innerHTML = data.data.id;
                    $('#viewModal').modal('show');
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }


    /**
     * 编辑文章
     * @param id
     * @param refreshContent
     */
    function editNote(id,refreshContent) {
        fetch('/base/anakki/note/note-detail?id='+id, {
            method: 'GET'
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    editNoteId=id;

                    document.getElementById("noteId").innerHTML = data.data.id;
                    let currentEditors = document.getElementById("current-editors");
                    currentEditors.innerHTML='';
                    // 检查是否有协作者
                    if (data.data.authorsDetail && data.data.authorsDetail.length > 0) {
                        // 遍历协作者信息并生成HTML内容
                        data.data.authorsDetail.forEach(author => {
                            currentEditors.innerHTML += `
                                <span class="d-inline-block" style="align-content: center;"
                                 tabindex="0" data-toggle="tooltip" title="${author.nickname}">
                                    <div class="author-item">
                                        <img src="${author.avatar}" alt="${author.nickname}" class="author-avatar"/>
                                    </div>
                                </span>

                            `;
                        });

                    }
                        const content = data.data.content;
                        thisAdEditor.setData(content);
                        showEditDraftNoteButton();
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    let currentPage = 1; // 当前页码
    let hasMoreData = true; // 是否有更多数据
    let searchKeyword = ''; // 搜索关键词

    let currentUserForNotePage = 1; // 当前页码
    let currentAuthorForNotePage = 1; // 当前页码
    function searchUserButton() {
        searchKeyword = document.getElementById('userSearchInput').value;
        listUsersForNote(false, searchKeyword); // 点击查询时重置数据
    }

    function listAuthorsAndUsersForNote(){
        listUsersForNote()
        listAuthorsForNote();
    }

    function listAuthorsForNote(loadMore = false) {
            const token = localStorage.getItem('user-token');
            if (!token) {
                alert("请登录");
                return;
            }
            if (!editNoteId) {
                alert("用户加载失败");
                return;
            }
            if (!loadMore) {
                currentAuthorForNotePage = 1;
                hasMoreData = true;
                document.getElementById("authorListForNoteEdit").innerHTML = ''; // 清空旧数据
            }
            if (!hasMoreData) {
                return; // 如果没有更多数据则不再请求
            }

            fetch(`/api/anakki/user/list-authors-for-note?noteId=${editNoteId}&current=${currentAuthorForNotePage}&size=10`, {
                method: 'GET',
                headers: {
                    'Authorization': token
                },
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        alert('网络错误，请联系管理员');
                    }
                })
                .then(data => {
                    if (data.code === 200) {
                        let userList = data.data.data;

                        // 如果没有更多数据，停止加载
                        if (userList.length === 0) {
                            hasMoreData = false;
                            return;
                        }

                        let html = '';
                        userList.forEach(user => {
                            html += `
                    <div class="list-group-item editor-select-for-note">
                        <img src="${user.avatar}" alt="${user.nickname}" style="width: 30px; height: 30px; border-radius: 50%;">
                        <span class="align-items-center">${user.nickname}</span>
                        <div class="form-check form-switch form-check-reverse align-items-center" style="display:inline-block;margin-left:15px;">
                          <input class="form-check-input collaborator-switch" type="checkbox" id="flexSwitch_${user.id}" data-author-id="${user.id}">
                          <label class="form-check-label" for="flexSwitch_${user.id}"></label>
                        </div>
                    </div>`;
                        });
                        document.getElementById("authorListForNoteEdit").insertAdjacentHTML('beforeend', html);

                        // 显示模态框
                        if (!loadMore) {
                            $('#userModalForNoteEdit').modal('show');
                        }

                        // 更新页码
                        currentAuthorForNotePage += 1;

                        // 监听滚动事件
                        document.getElementById("authorListContainer").addEventListener('scroll', handleAuthorScroll);
                    } else {
                        alert(data.data);
                    }
                })
                .catch(error => {
                    alert('系统错误: ' + error);
                });
        }
    function listUsersForNote(loadMore = false, keyword = '') {
        const token = localStorage.getItem('user-token');
        if (!token) {
            alert("请登录");
            return;
        }
        if (!editNoteId) {
            alert("用户加载失败");
            return;
        }
        if (!loadMore) {
            currentUserForNotePage = 1;
            hasMoreData = true;
            document.getElementById("userListForNoteEdit").innerHTML = ''; // 清空旧数据
        }
        if (!hasMoreData) {
            return; // 如果没有更多数据则不再请求
        }

        fetch(`/api/anakki/user/list-for-note?noteId=${editNoteId}&current=${currentUserForNotePage}&size=10&keyword=${encodeURIComponent(keyword)}`, {
            method: 'GET',
            headers: {
                'Authorization': token
            },
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    alert('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    let userList = data.data.data;

                    // 如果没有更多数据，停止加载
                    if (userList.length === 0) {
                        hasMoreData = false;
                        return;
                    }

                    let html = '';
                    userList.forEach(user => {
                        html += `
                    <div class="list-group-item editor-select-for-note">
                        <img src="${user.avatar}" alt="${user.nickname}" style="width: 30px; height: 30px; border-radius: 50%;">
                        <span class="align-items-center">${user.nickname}</span>
                        <div class="form-check form-switch form-check-reverse align-items-center" style="display:inline-block;margin-left:15px;">
                          <input class="form-check-input collaborator-switch" type="checkbox" id="flexSwitch_${user.id}" ${user.isCollaborator ? 'checked' : ''} data-user-id="${user.id}">
                          <label class="form-check-label" for="flexSwitch_${user.id}"></label>
                        </div>
                    </div>`;
                    });
                    document.getElementById("userListForNoteEdit").insertAdjacentHTML('beforeend', html);

                    // 显示模态框
                    if (!loadMore) {
                        $('#userModalForNoteEdit').modal('show');
                    }

                    // 更新页码
                    currentUserForNotePage += 1;

                    // 监听滚动事件
                    document.getElementById("userListContainer").addEventListener('scroll', handleScroll);

                } else {
                    alert(data.data);
                }
            })
            .catch(error => {
                alert('系统错误: ' + error);
            });
    }
    function handleAuthorScroll() {
        const container = document.getElementById("userListContainer");
        // 当滚动到底部时加载更多数据
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
            container.removeEventListener('scroll', handleAuthorScroll);
            listAuthorsForNote(true);
        }
    }

    // 处理滚动事件
    function handleScroll() {
        const container = document.getElementById("userListContainer");

        // 当滚动到底部时加载更多数据
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
            container.removeEventListener('scroll', handleScroll);
            listUsersForNote(true, searchKeyword);
        }
    }
    function removeAuthorFromNotes() {
        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }

        const selectedUsers = Array.from(document.querySelectorAll(".collaborator-switch"))
            .filter(switchElement => switchElement.checked) // 仅选择打开开关的用户
            .map(switchElement => switchElement.getAttribute('data-author-id')); // 获取用户ID

        const payload = {
            authorIds: selectedUsers,  // 已选中的用户ID
            targetNoteId: editNoteId
        };

        fetch('/api/anakki/note/removeAuthorToNotes', {
            method: 'POST',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('协作者已成功移除');
                    listAuthorsAndUsersForNote()
                } else {
                    alert('添加协作者失败: ' + data.message);
                }
            })
            .catch(error => {
                alert('系统错误: ' + error);
            });
    }
    function addAuthorToNotes() {
        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }

        const selectedUsers = Array.from(document.querySelectorAll(".collaborator-switch"))
            .filter(switchElement => switchElement.checked) // 仅选择打开开关的用户
            .map(switchElement => switchElement.getAttribute('data-user-id')); // 获取作者ID

        const payload = {
            authorIds: selectedUsers,  // 已选中的用户ID
            targetNoteId: editNoteId
        };

        fetch('/api/anakki/note/addAuthorToNotes', {
            method: 'POST',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('协作者已成功添加');
                    listAuthorsAndUsersForNote()
                } else {
                    alert('添加协作者失败: ' + data.message);
                }
            })
            .catch(error => {
                alert('系统错误: ' + error);
            });
    }

    function viewDraftNote(id) {
        fetch('/base/anakki/note/note-detail?id='+id, {
            method: 'GET'
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    document.getElementById("viewDraftModalBody").innerHTML = data.data.content;
                    $('#viewDraftModal').modal('show');
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    function scrollToBottom() {
        var textarea = document.getElementById('adContent');
        textarea.scrollTop = textarea.scrollHeight - textarea.clientHeight;
    }

    /**
     * 保存草稿
     */
    function saveDraft() {
        const data = thisAdEditor.getData()

        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }
        // Make an AJAX POST request
        fetch('/api/anakki/an-note-draft/saveNoteDraft', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify({content: data}),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    // Handle error response
                    console.error('网络错误，请联系管理员');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    const noteId = data.data.data;
                    localStorage.setItem('noteId', noteId);
                    alert("保存成功")
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    /**
     * 发布新作品
     */
    function publish() {
        if (document.getElementById("noteId").innerHTML===''){
            createNote();
        }else{
            updateNote();
        }
    }
    function updateNote(){
        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }
        const data = thisAdEditor.getData()
        if (!data){
            alert("请输入内容")
        }
        const noteId = document.getElementById("noteId").innerHTML;
        document.getElementById('loading-overlay').style.display = 'flex';
        fetch('/api/anakki/note/updateNote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify(
                {
                    id: noteId,
                    content: data
                }
            ),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                document.getElementById('loading-overlay').style.display = 'none';
                if (data.code === 200) {
                    alert("修改成功")
                    document.getElementById('publish-area').style.display= '';
                    document.getElementById("noteId").innerHTML='';
                    //清空编辑区
                    thisAdEditor.setData('');
                    showNotesButton()
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function createNote(){
        const token = localStorage.getItem('user-token');
        if (!token){
            alert("请登录")
        }
        const data = thisAdEditor.getData()
        if (!data){
            alert("请输入内容")
        }
        const noteId = document.getElementById("noteId").innerHTML;
        document.getElementById('loading-overlay').style.display = 'flex';
        fetch('/api/anakki/note/createNote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify(
                {
                    id: noteId,
                    content: data
                }
            ),
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                document.getElementById('loading-overlay').style.display = 'none';
                if (data.code === 200) {
                    alert("发布成功")
                    document.getElementById('publish-area').style.display= '';
                    document.getElementById("noteId").innerHTML='';
                    //清空编辑区
                    thisAdEditor.setData('');
                    showNotesButton()
                } else {
                    alert(data.data)
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 当前页数和每页数据大小
    let currentViewNotePage = 1;
    const pageSize = 10;
    let isLoading = false; // 防止重复加载
    let hasMoreNotes = true; // 判断是否还有更多数据
    let loadingOverlay;
    function searchButton() {
        currentViewNotePage=1
        if (draftListDiv.style.display === 'block') {
            document.getElementById("draftList").innerHTML = "";
            listDrafts(currentViewNotePage++, 10);
        }else if (noteListDiv.style.display === 'block') {
            hasMoreNotes=true;
            currentViewNotePage = 1;
            document.getElementById("noteList").innerHTML = "";
            listNotes(currentViewNotePage++, 10);
        }

    }
    function handleViewNoteScroll() {
        if (document.getElementById('noteList').style.display!== 'block'){
            return;
        }
        const scrollableElement = document.documentElement || document.body;
        if (scrollableElement.scrollHeight - scrollableElement.scrollTop === scrollableElement.clientHeight) {
                loadMoreNotes();
        }
    }
    window.addEventListener('scroll', () => {
         // 用户滚动之后关闭初始状态
        handleViewNoteScroll();
    });

    // 加载数据函数
    function loadMoreNotes() {
        if (isLoading) return; // 防止重复加载
        isLoading = true;
         // 页数递增
        listNotes(currentViewNotePage++, pageSize);
    }

    let groupUrl="";
    function listNotes(current, pageSize,groupId) {
        if (!hasMoreNotes) {
            return;
        }

        document.getElementById('loading-overlay').style.display = 'flex';

        let searchInput = document.getElementById("searchInputText").value;
        let searchUrl = searchInput ? `&content=${searchInput}` : "";
        const url = window.location.href;
        groupUrl = groupId ? `&noteGroupId=${groupId}` : groupUrl;
        // 发送 AJAX 请求
        fetch(`/base/anakki/note/listNote?current=${current}&size=${pageSize}${searchUrl}${groupUrl}`, {
            method: 'GET',
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                let index=200;
                const itemList = data.data.data;
                let html = "";
                if (itemList.length < pageSize) {
                    hasMoreNotes = false;
                }
                // 遍历每个项目
                itemList.forEach(item => {
                    index+=200;
                    const coverImgHtml = item.coverImage
                        ? `<img class="cover-img" src="${item.coverImage}">`
                        : "";

                    html += `
                    <div class="note-node-content col-12 note-node div-trans-${index}">
                        <div class="note-node-title">
                            <h4 style="margin-top: 0.5rem;">
                                <i class="bi bi-bookmark-check-fill"></i> ${item.title}
                            </h4>
                            <div class="dropdown">
                                <div class="note-node-title-dropdown-icon" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bi bi-grid-fill"></i>
                                </div>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" onclick='viewNote(${item.id})'>
                                        <i class="bi bi-chevron-bar-contract"></i>
                                    </a>
                                    <a class="dropdown-item" href="#" onclick='editNote(${item.id})'>
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <a class="dropdown-item" href="#" onclick='deleteNote(${item.id})'>
                                        <i class="bi bi-trash-fill"></i>
                                    </a>
                                    <a class="dropdown-item" href="#" onclick='listNoteHistory(${item.id})'>
                                        <i class="bi bi-clock-history"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <hr style="margin-bottom: 0.5rem; margin-top: 0.5rem;">
                        <div class="note-node-description">${item.description}
                            <a href="#" onclick='viewNote(${item.id})'>...查看更多</a>
                        </div>
                        <hr style="margin-bottom: 0.5rem;">
                        <div class="note-node-time">
                            <i class="bi bi-eye"></i> ${item.viewCount} | ${item.createTime.replace("T", " ")}
                        </div>
                    </div>
                `;
                });
                document.getElementById("noteList").insertAdjacentHTML('beforeend', html);

                // 拼接分页参数到地址栏
                const newUrl = `${url.split("?")[0]}?current=${current}&size=${pageSize}${searchUrl}${groupUrl}`;
                window.history.replaceState(null, null, newUrl);

                isLoading = false;
                document.getElementById('buttonSpinner').style.display = 'none';
                document.getElementById('loading-overlay').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载失败，请稍后重试！');
            });
    }
    function listDrafts(current, pageSize, searchInput) {
        let searchUrl="";
        if (null != searchInput && "" !== searchInput) {
            searchUrl = searchUrl+"&content=" + searchInput;
        }
        const url = window.location.href;
        const token = localStorage.getItem('user-token');
        // Make an AJAX POST request
        fetch('/api/anakki/note/listDraftNote?' + current + "&size=" + pageSize + "&status=Draft" + searchUrl, {
            method: 'GET',
            headers: {
                'authorization': token
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON data
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                if (data.code===200){
                    const itemList = data.data.data;
                    let html = "";
                    for (let i = 0; i < itemList.length; i++) {
                        const item = itemList[i];

                        let coverImgHtml="";
                        if (null!=item.coverImage){
                            coverImgHtml=
                                "                    <img class=\"cover-img\"\n" +
                                "                         src="+item.coverImage+">"
                        }

                        html +=
                            "<span class=\"note-node row\">\n" +
                            "                <div class=\"note-node-cover col-2\">\n" +
                            coverImgHtml+
                            "</div>"+
                            "                <div class=\"note-node-content col-10\">\n" +
                            "                    <div class=\"note-node-title\">\n" +
                            "                        <h4>"+item.title+"</h4>\n" +
                            "        <div class=\"dropdown\">\n" +
                            "            <div class=\"\" type=\"button\" id=\"dropdownMenuButton\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\n" +
                            "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-grid-3x2-gap-fill\" viewBox=\"0 0 16 16\">\n" +
                            "  <path d=\"M1 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V4zM1 9a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V9zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V9z\"/>\n" +
                            "</svg>"+
                            "            </div>\n" +
                            "            <div class=\"dropdown-menu\" aria-labelledby=\"dropdownMenuButton\">\n" +
                            "                <a class=\"dropdown-item\" href=\"#\" onclick='viewDraftNote("+item.id+")'>" +
                            "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-view-list\" viewBox=\"0 0 16 16\">\n" +
                            "  <path d=\"M3 4.5h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1H3zM1 2a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 2zm0 12a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 14z\"/>\n" +
                            "</svg>"+
                            "                </a>\n" +
                            "                <a class=\"dropdown-item\" href=\"#\" >" +
                            "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-pencil-square\" viewBox=\"0 0 16 16\">\n" +
                            "  <path d=\"M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z\"/>\n" +
                            "  <path fill-rule=\"evenodd\" d=\"M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z\"/>\n" +
                            "</svg>"+
                            "                </a>\n" +
                            "                <a class=\"dropdown-item\" href=\"#\" onclick='deleteDraftNote("+item.id+")'>" +
                            "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-trash\" viewBox=\"0 0 16 16\">\n" +
                            "  <path d=\"M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z\"/>\n" +
                            "  <path fill-rule=\"evenodd\" d=\"M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z\"/>\n" +
                            "</svg>"+
                            "                </a>\n" +
                            "                <a class=\"dropdown-item\" href=\"#\" onclick='listDraftNoteHistory("+item.id+")'>" +
                            "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-clock-history\" viewBox=\"0 0 16 16\">\n" +
                            "  <path d=\"M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z\"/>\n" +
                            "  <path d=\"M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z\"/>\n" +
                            "  <path d=\"M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z\"/>\n" +
                            "</svg>"+
                            "                </a>\n" +
                            "            </div>\n" +
                            "        </div>"+
                            "                    </div>\n" +
                            "                    <div class=\"note-node-description\" onclick='viewNote("+item.id+")'>"+item.description+"</div>\n" +
                            "                </div>\n" +
                            "            </span>";
                    }
                    document.getElementById("draftList").innerHTML = html;
                    // 拼接分页参数到地址栏
                    const newUrl = url.split("?")[0] + "?current=" + current + "&size=" + pageSize + searchUrl;
                    window.history.replaceState(null, null, newUrl);
                }else{
                    alert(data.data)
                }

            })
            .catch(error => {
                alert(error)
            });
    }

    function listDraftNoteHistory(id){

    }
    function listNoteHistory(id){

    }


    class MyUploadAdapter {
        constructor(loader) {
            // 上载期间要使用的文件加载器实例
            this.loader = loader;
        }

        // 启动上传过程
        upload() {
            return this.loader.file
                .then(file => new Promise((resolve, reject) => {
                    this._initRequest();
                    this._initListeners(resolve, reject, file);
                    this._sendRequest(file);
                }));
        }

        // 中止上传过程
        abort() {
            if (this.xhr) {
                this.xhr.abort();
            }
        }

        // 初始化 XMLHttpRequest 对象使用URL传递给构造函数
        _initRequest() {
            const xhr = this.xhr = new XMLHttpRequest();
            // *使用JSON作为数据结构的POST请求,url根据实际情况配置
            xhr.open('POST', '/api/anakki/note/uploadFiles', true);
            xhr.responseType = 'json';
        }

        // 初始化XMLHttpRequest监听器
        _initListeners(resolve, reject, file) {
            const xhr = this.xhr;
            const loader = this.loader;
            const genericErrorText = `无法上传文件: ${file.name}.`;

            xhr.addEventListener('error', () => reject(genericErrorText));
            xhr.addEventListener('abort', () => reject());
            xhr.addEventListener('load', () => {
                const response = xhr.response;
                if (response.code === 101) {
                    alert(response.data)
                } else {
                    // 上传成功的处理
                    resolve({
                        default: response.data
                    });
                }
            });

            // 编辑器用户界面中显示上传进度条
            if (xhr.upload) {
                xhr.upload.addEventListener('progress', evt => {
                    if (evt.lengthComputable) {
                        loader.uploadTotal = evt.total;
                        loader.uploaded = evt.loaded;
                    }
                });
            }
        }

        // 准备数据并发送请求
        _sendRequest(file) {
            // 准备表单数据
            const data = new FormData();
            data.append('uploadFiles', file);
            // 实现认证和CSRF保护等安全机制
            this.xhr.setRequestHeader('authorization', localStorage.getItem('user-token'));
            // 发送请求.
            this.xhr.send(data);
        }
    }

    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
            // 配置上传脚本的后端URL
            return new MyUploadAdapter(loader);
        };
    }

    const noteListDiv = document.getElementById('noteList');
    const draftListDiv = document.getElementById('draftList');
    const createDraftDiv = document.getElementById('createDraft');

    function showNotesButton(){
        if (noteListDiv.style.display === 'none'||noteListDiv.style.display === '') {
            noteListDiv.style.display = 'block';
            createDraftDiv.style.display = 'none';
            draftListDiv.style.display = 'none';

            document.getElementById('publish-area').style.display= 'none';
            document.getElementById("noteList").innerHTML = "";
            hasMoreNotes=true;
            currentViewNotePage=1
            listNotes(currentViewNotePage++, 10,document.getElementById("searchInputText").value);
        }
    }
    function showDraftNotesButton() {
        if (draftListDiv.style.display === 'none'||draftListDiv.style.display === '') {
            draftListDiv.style.display = 'block';
            noteListDiv.style.display = 'none';
            createDraftDiv.style.display = 'none';
            document.getElementById('publish-area').style.display= 'none';
            listDrafts(1, 10, document.getElementById("searchInputText").value)
        }
    }

    function showEditDraftNoteButton(){
        if (createDraftDiv.style.display === 'none'||createDraftDiv.style.display === '') {
            document.getElementById('publish-area').style.display= '';
            createDraftDiv.style.display = 'block';
            noteListDiv.style.display = 'none';
            draftListDiv.style.display = 'none';
        }
    }

</script>
</body>
</html>