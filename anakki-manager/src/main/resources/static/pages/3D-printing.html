<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。                             ">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->

    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
</head>
<style>

    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    body {
        color: #eaeaea;
        background-color: #2c6863;
    }

    .vertical-span {
        display: block;
        margin-left: 1.4rem;
        margin-bottom: 0.2rem;
        font-size: 0.7rem;
    }

    .golden-ratio-image {
        width: 175px;
        height: calc(175px / 1.618);
        border-radius: 1.0rem;
    }

    .table th, .table td {
        padding: 0.4rem;
        vertical-align: top;
        border-top: .1rem solid #000;
    }

    .scrollable-td {
        max-width: 4rem; /* 设置最大宽度，根据实际情况调整 */
        overflow-x: auto; /* 水平滚动条 */
    }

    .page-item.disabled .page-link {
        color: #ffffffc4;
        pointer-events: none;
        cursor: auto;
        background-color: #fff0;
        border-color: #dee2e600;
    }

    .page-item.active .page-link {
        z-index: 1;
        color: #ffffffd6;
        background-color: #288cff00;
        border-color: #288cff73;
    }

    .search-button {
        border-top-left-radius: 0.0rem;
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
        border-bottom-left-radius: 0.0rem;
    }
</style>
<body>
<!--通用顶部导航-->
<div id="header"></div>

<main class="main">
    <div style="margin-top: 4rem;">
        <ul class="nav justify-content-center">
            <div class="container" style="height: 48rem;">
                <div class="input-group mb-3 mt-1">
                    <input id="searchInputText" type="text" class="form-control" placeholder="模型名称"
                           aria-label="模型名称" aria-describedby="button-addon2">
                    <button class="btn search-button" type="button" id="button-addon2" onclick="searchButton()">搜索
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table align-items-center" data-resizable="true">
                        <thead style="color: #000;">
                        <tr class="" scope="row">
                            <th scope="col">模型图片</th>
                            <th scope="col">标题</th>
                            <th scope="col">描述</th>
                            <th scope="col" style="min-width: 55px;">下载量</th>
                            <th scope="col" style="min-width: 55px;">下载</th>
                        </tr>
                        </thead>
                        <tbody id="list" style="color: darkgray;">

                        </tbody>
                    </table>
                </div>
                <div class="row justify-content-end" style="margin-bottom: 0.5rem;">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal"
                            style="line-height: 0;">
                        抽奖
                    </button>
                    <ul class="pagination" id="page-module">
                    </ul>
                </div>
            </div>
        </ul>
    </div>
    <div>
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="myModalLabel">抽奖工具</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="openNameForm">
                            <label for="gift">礼物</label>
                            <input type="text" class="form-control" id="gift" name="gift"><br>

                            <label for="names">候选人:(参与人以逗号,分隔)</label>
                            <input type="text" class="form-control" id="names" name="names"><br>

                            <label for="openTime">开奖时间:</label>
                            <input type="datetime-local" class="form-control" id="openTime" name="openTime"><br>
                            <button type="submit" class="btn btn-primary">提交</button>
                        </form>
                    </div>
                    <button id="historyButton" class="btn btn-primary">历史开奖</button>
                    <div class="modal-body">
                        <table class="table table-hover align-items-center" data-resizable="true">
                            <thead>
                            <tr class="bg-white" scope="row">
                                <th scope="col">发起人</th>
                                <th scope="col">奖品</th>
                                <th scope="col">参与人</th>
                                <th scope="col">中奖人</th>
                                <th scope="col">开奖时间
                                </th>
                            </tr>
                            </thead>
                            <tbody id="openList" style="color: darkgray;">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div>
        <div class="modal fade" id="3dPrintImgModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document" style="max-width: 1140px;">
                <div class="modal-content" style="background-color: #686868;">
                    <div class="modal-body" style="border-radius: 1.4rem;">
                        <img src="" id="3dPrintImg" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>
<script>

    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);
        $('#footer').load("../pages/footer.html", insertCreateTime);
        list3dModelFile(1, 10)
        lightbox.option({
            'resizeDuration': 200,
            'wrapAround': true
        });
    };


    $(document).ready(function () {
        $('#openNameForm').submit(function (event) {
            event.preventDefault();

            const names = $('#names').val().split(','); // 以逗号分隔输入的名字
            const openTime = $('#openTime').val();
            const gift = $('#gift').val();
            const data = {
                names: names,
                openTime: openTime,
                gift: gift
            };

            $.ajax({
                type: "POST",
                url: "/api/anakki/3dModel/setRandomName",
                contentType: "application/json",
                data: JSON.stringify(data),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('authorization', localStorage.getItem('user-token')); // Include the token in the Authorization header
                },
                success: function (response) {
                    if (101 === response.code) {
                        alert(response.data)
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Failed to submit data: " + error);
                }
            });
            // 关闭模态框
            $('#myModal').modal('hide');
        });
    });
    $(document).ready(function () {
        $('#historyButton').click(function () {
            // 在这里添加按钮点击时要执行的方法
            listOpenName(); // 调用名为showHistory的方法
        });
    });

    function searchButton() {
        const input = document.getElementById("searchInputText").value;
        list3dModelFile(1, 10, input);
    }

    function list3dModelFile(current, pageSize, searchInput) {
        if (null == searchInput || "" === searchInput) {
            searchInput = "";
        } else {
            searchInput = "&searchInput=" + searchInput;
        }
        const url = window.location.href;
        const get = new XMLHttpRequest();
        get.open("GET", "/base/anakki/3dModel/list-3dModels?current=" + current + "&size=" + pageSize + searchInput, true);
        get.onreadystatechange = function () {
            if (get.readyState === 4 && get.status === 200) {
                let html = "";
                const response = JSON.parse(get.responseText);

                const itemList = response.data.data;
                const totalNum = response.data.totalNum;

                for (let i = 0; i < itemList.length; i++) {
                    const item = itemList[i];
                    const id = item.id;
                    const type = item.type;
                    const title = item.title;
                    const description = item.description;
                    const downloadCount = item.downloadCount;
                    const modelImageUrl = item.modelImageUrl;
                    const fileSize = (item.fileSize / 1024).toFixed(2);
                    const createTime = item.createTime;
                    html = html + "                           <tr>\n" +
                        "                                    <td>\n" +
                        "                                        <div class=\"media align-items-center\">\n" +
                        "                                            <div>\n" +
                        "                                                 <img src=\"" + modelImageUrl + "\" alt=\"" + title + "\" class=\"golden-ratio-image\" data-toggle=\"modal\" data-target=\"#3dPrintImgModal\" onclick='viewImg(this)'>\n" +
                        "                                            </div>\n" +
                        "                                            <div class=\"media-body\" style=\"min-width: 200px;\">\n" +
                        "                                                <span class=\"vertical-span\">文件大小" + fileSize + "MB</span>" +
                        "                                                <span class=\"vertical-span\">上传时间：" + createTime.replace("T", " ") + "</span>\n" +
                        "                                            </div>\n" +
                        "                                        </div>\n" +
                        "                                    </td>\n" +
                        "                                    <td>" + title + "</td>\n" +
                        "                                    <td>" + description + "</td>\n" +
                        "                                    <td>" + downloadCount + "</td>\n" +
                        "    <td>\n" +
                        "        <div style='color: #00ff58;' onclick=\"downloadModel(" + id + ")\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" fill=\"currentColor\" class=\"bi bi-download\" viewBox=\"0 0 16 16\">\n" +
                        "  <path d=\"M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z\"/>\n" +
                        "  <path d=\"M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z\"/>\n" +
                        "</svg></div>\n" +
                        "    </td>\n" +
                        "                                </tr>"
                }
                document.getElementById("list").innerHTML = html;
                let totalPages = Math.ceil(totalNum / pageSize);
                initPage(current, pageSize, totalPages);
                // 拼接分页参数到地址栏
                const newUrl = url.split("?")[0] + "?current=" + current + "&size=" + pageSize;
                window.history.replaceState(null, null, newUrl);
            }
        };
        get.send();
    }

    function viewImg(html) {
        document.getElementById("3dPrintImg").src = html.src;
    }

    function listOpenName() {
        const get = new XMLHttpRequest();
        get.open("GET", "/base/system/getRandomName", true);
        get.onreadystatechange = function () {
            if (get.readyState === 4 && get.status === 200) {
                let html = "";
                const response = JSON.parse(get.responseText);

                const itemList = response.data;
                for (let i = 0; i < itemList.length; i++) {
                    const item = itemList[i];
                    const users = item.users;
                    const giftName = item.giftName;
                    const initiator = item.initiator;
                    let winners = item.winners;
                    if (null == winners) {
                        winners = "未开奖";
                    }
                    const openTime = item.openTime;
                    // 去掉时间字符串中的"T"
                    const cleanedTimeString = openTime.replace("T", " ");
                    html = html + "<tr>\n" +
                        "<td>" + initiator + "</td>" +
                        "<td  class=\"scrollable-td\">" + giftName + "</td>" +
                        "<td class=\"scrollable-td\">" + users + "</td>" +
                        "<td>" + winners + "</td>" +
                        "<td>" + cleanedTimeString + "</td>" +
                        "</tr>"
                }
                document.getElementById("openList").innerHTML = html;
            }
        };
        get.send();
    }

    function initPage(currentPage, pageSize, totalPages) {
        const paginationContainer = document.getElementById("page-module");
        let html = "";
        // Previous page button
        if (currentPage > 1) {
            let number = currentPage - 1;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${number}, '${pageSize}')">上一页</a></li>`;
        } else {
            html += `<li class="page-item disabled"><a class="page-link" href="#"><<</a></li>`;
        }
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${i}, '${pageSize}')">${i}</a></li>`;
            }
        }
        // Next page button
        if (currentPage < totalPages) {
            let number = currentPage + 1;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="list3dModelFile(${number}, '${pageSize}')">下一页</a></li>`;
        } else {
            html += `<li class="page-item disabled"><a class="page-link" href="#">>></a></li>`;
        }
        paginationContainer.innerHTML = html;
    }

    function toggleSection(sectionId) {
        const sections = document.getElementsByClassName('section');
        for (let i = 0; i < sections.length; i++) {
            sections[i].classList.remove('active');
        }
        const section = document.getElementById(sectionId);
        section.classList.add('active');
    }


    function downloadModel(id) {
        const get = new XMLHttpRequest();
        get.open("GET", "/api/anakki/3dModel/download?id=" + id, true);
        get.onreadystatechange = function () {
            if (get.readyState === 4 && get.status === 200) {
                const response = JSON.parse(get.responseText);
                if (101 === response.code) {
                    alert(response.data)
                } else {
                    const downloadUrl = response.data;
                    window.open(downloadUrl);
                }
            }
        };
        get.setRequestHeader('authorization', localStorage.getItem('user-token'));
        get.send();
    }

</script>
</body>
</html>