<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="æ—¶å…‰èƒ¶å›Š,Anakkiçš„ä¸ªäººç½‘ç«™,æ‘„å½±,åšå®¢,æŠ€æœ¯åˆ†äº«ã€‚">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->

    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">

    <style>
        body {
            color: #495751b8;
            background-color: rgba(3, 94, 0, 0.27);
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Your existing CSS styles */
        .chat-header {
            background-color: rgba(0, 204, 126, 0);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(221, 221, 221, 0.16);
            position: fixed;
            top: 60px;
            width: 100%;
            z-index: 1;
        }

        .chat-header h4 {
            margin: 0;
        }

        .chat-header h2 {
            margin-left: 10px;
            color: #f0f0f0;
        }

        .chat-body {
            position: relative;
            flex: 1;
            margin-top: 123px;
            margin-bottom: 60px;
            overflow-y: auto;
            padding: 15px;
            background-color: #ccc0;
            transition: background-color 3s ease, color 3s ease;
        }

        /* å¤´åƒå’ŒèŠå¤©æ°”æ³¡é å³ */
        .chat-message.me {
            justify-content: flex-end;
        }

        .chat-message.me .chat-message-content {
            background-color: rgba(178, 255, 117, 0);
            text-align: right;
            align-self: flex-end; /* ç¡®ä¿èŠå¤©æ°”æ³¡é å³ */
            border-radius: 9px;
        }
        .chat-message.me .chat-message-content p{
            background-color: rgba(164, 255, 91, 0.67);
            text-align: left;
            border-radius: 9px;
            color: black;
            font-weight: bold;
        }

        .chat-message.me .chat-message-content div{
            background-color: rgba(178, 255, 117, 0);
            text-align: right;
            align-self: flex-end; /* ç¡®ä¿èŠå¤©æ°”æ³¡é å³ */
            border-radius: 9px;
        }
        .chat-message.me img {
            order: 1; /* ç¡®ä¿å¤´åƒåœ¨èŠå¤©æ°”æ³¡åé¢ */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            margin-right: 0 !important;
        }

        /* å…¶ä»–èŠå¤©æ¶ˆæ¯çš„æ ·å¼ä¿æŒä¸å˜ */
        .chat-message {
            display: flex;
            margin-bottom: 10px;
        }

        .chat-message img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px; /* é»˜è®¤å¤´åƒåœ¨èŠå¤©æ°”æ³¡å‰é¢ */
        }

        .chat-message-content {
            max-width: 80%;
            border-radius: 9px;
            color: #131313d9;
            background-color: rgba(245, 245, 245, 0);
        }
        .chat-message .chat-message-content div{
            background-color: rgba(178, 255, 117, 0);
            text-align: left;
            align-self: flex-end; /* ç¡®ä¿èŠå¤©æ°”æ³¡é å³ */
            border-radius: 9px;
        }
        .chat-message .chat-message-content p {
            background-color: rgba(0, 0, 0, 0.25);
            padding: 10px;
            border-radius: 10px;
            margin: 0;
            color: white;
            white-space: pre-wrap;
        }

        .chat-footer {
            border-top: 1px solid #0000004d;
            padding: 10px;
            background-color: #242424;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .chat-footer textarea {
            flex: 1;
            margin-right: 10px;
        }

        .chat-footer button {
            background-color: #77777780;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
        }
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa00;
        }

        .chat-title {
            margin-right: auto;
        }

        .room-id {
            margin: 0 auto;
            text-align: center;
        }

        .room-id-input {
            display: flex;
            align-items: center;
        }

        #roomInput {
            margin-right: 10px; /* è¾“å…¥æ¡†å’ŒæŒ‰é’®ä¹‹é—´çš„é—´è· */
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            padding: 20px;
            display: none; /* åˆå§‹çŠ¶æ€ä¸‹éšè— */
            flex-shrink: 0;
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 20px;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar ul li {
            margin-bottom: 10px;
            color: #ecf0f1;
            cursor: pointer;
        }
        .chat-message-nickname{
            font-weight: bold;
        }
        .chat-timestamp {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin: 10px 0;
            font-style: italic;
        }

        .dark-mode {
            background-color: #333;
            color: #f0f0f0;
        }

        .theme-toggle {
            position: absolute;
            top: 53px;
            right: 46%;
            border: none;
            border-radius: 100%;
            cursor: pointer;
            font-size: 2rem;
            transition: background-color 3s ease, color 3s ease;
            background-color: rgba(51, 51, 51, 0);
        }

        .theme-toggle.dark-mode {
            background-color: rgba(51, 51, 51, 0);
            color: #f0f0f0;
        }
        button:focus {
            outline: 0 dotted;
            outline: 0 auto -webkit-focus-ring-color;
        }
        .form-control {
            display: block;
            width: 100%;
            padding: .4rem 0.5rem;
            font-size: .875rem;
            line-height: 1.6;
            color: #495057;
            background-color: #fff0;
            background-clip: padding-box;
            border: .0625rem solid #ced4da40;
            border-radius: .375rem;
            box-shadow: none;
            transition: all 0.2s ease-in-out;
        }
        .modal-header {
            margin: 0.5rem;
        }
    </style>

</head>
<body>
<!--é€šç”¨é¡¶éƒ¨å¯¼èˆª-->
<div id="header"></div>
<main class="main">
    <div class="bg-cover bg-size--cover" data-spotlight="fullscreen"
         style="background-image: url('https://securex-1258150206.cos.ap-beijing.myqcloud.com/backend/DSC07694.jpg')">
        <div class="chat-section">
            <!-- Chat Header -->
            <div class="chat-header">
                <!--å·¦ä¾§è¾¹æ -->
                <h4 class="chat-title toggle-sidebar-button" id="toggleSidebarButton">
                    <div class="btn-group">
                        <div class="" type="button" data-toggle="dropdown" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-grid" viewBox="0 0 16 16">
                                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                            </svg>
                        </div>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" type="button" data-toggle="tooltip" data-placement="left" title="æœ‰æ–°æ¶ˆæ¯æ—¶å‘é€é‚®ä»¶">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-at-fill" viewBox="0 0 16 16">
                                    <path d="M2 2A2 2 0 0 0 .05 3.555L8 8.414l7.95-4.859A2 2 0 0 0 14 2H2Zm-2 9.8V4.698l5.803 3.546L0 11.801Zm6.761-2.97-6.57 4.026A2 2 0 0 0 2 14h6.256A4.493 4.493 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586l-1.239-.757ZM16 9.671V4.697l-5.803 3.546.338.208A4.482 4.482 0 0 1 12.5 8c1.414 0 2.675.652 3.5 1.671Z"/>
                                    <path d="M15.834 12.244c0 1.168-.577 2.025-1.587 2.025-.503 0-1.002-.228-1.12-.648h-.043c-.118.416-.543.643-1.015.643-.77 0-1.259-.542-1.259-1.434v-.529c0-.844.481-1.4 1.26-1.4.585 0 .87.333.953.63h.03v-.568h.905v2.19c0 .272.18.42.411.42.315 0 .639-.415.639-1.39v-.118c0-1.277-.95-2.326-2.484-2.326h-.04c-1.582 0-2.64 1.067-2.64 2.724v.157c0 1.867 1.237 2.654 2.57 2.654h.045c.507 0 .935-.07 1.18-.18v.731c-.219.1-.643.175-1.237.175h-.044C10.438 16 9 14.82 9 12.646v-.214C9 10.36 10.421 9 12.485 9h.035c2.12 0 3.314 1.43 3.314 3.034v.21Zm-4.04.21v.227c0 .586.227.8.581.8.31 0 .564-.17.564-.743v-.367c0-.516-.275-.708-.572-.708-.346 0-.573.245-.573.791Z"/>
                                </svg>
                                é‚®ç®±
                            </button>
                            <button class="dropdown-item" type="button" data-toggle="tooltip" data-placement="left" title="æœ‰æ–°æ¶ˆæ¯æ—¶å‘é€çŸ­ä¿¡">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone-forward-fill" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511zm10.761.135a.5.5 0 0 1 .708 0l2.5 2.5a.5.5 0 0 1 0 .708l-2.5 2.5a.5.5 0 0 1-.708-.708L14.293 4H9.5a.5.5 0 0 1 0-1h4.793l-1.647-1.646a.5.5 0 0 1 0-.708z"/>
                                </svg>
                                æ‰‹æœºå·
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item disabled" type="button">æˆ¿é—´</div>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <button class="dropdown-item" type="button">æµ‹è¯•2</button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" type="button" data-toggle="modal" data-target="#chatroomSettingMoal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                                </svg>
                                è®¾ç½®
                            </button>

                        </div>
                    </div>
                </h4>

<!--                æš—é»‘æ¨¡å¼-->
                <button id="themeToggle" class="theme-toggle">ğŸŒ•</button>


<!--                æˆ¿å·è¾“å…¥æ¡†-->
                <div class="room-id-input"  data-toggle="tooltip" data-placement="left" title="è¾“å…¥æˆ¿é—´å·ç ">
                    <input class="form-control" type="text" id="roomInput" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" data-emojiable="true">
                    <div class="btn input-group-append" id="setRoomIdButton" class="btn btn-default ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Chat Body -->
            <!-- Chat content here -->

            <div class="chat-body" id="chatContent">
            </div>
            <!-- Chat Footer -->
            <div class="chat-footer">
                <textarea id="message-input" class="form-control" data-emojiable="true" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" style="resize: none;"></textarea>
                <button type="button" id="send-button">å‘é€</button>
            </div>
        </div>
    </div>
</main>


<!-- èŠå¤©æ¡†è®¾ç½® Modal -->
<div class="modal fade" id="chatroomSettingMoal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                    </svg>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button></h5>
            </div>
            <div class="modal-body">
                è®¾ç½®
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!-- é¡µé¢åº•éƒ¨ -->
<div id="footer"></div>
<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>



<script>
    // æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®çš„æ ‡å¿—
    let isLoading = false;
    const setRoomIdButton = document.getElementById('setRoomIdButton');
    const roomInput = document.getElementById('roomInput');
    const roomIdElement = document.getElementById('roomId');
    const chatContent = document.getElementById('chatContent');
    const roomName = document.getElementById('roomName');
    let oldRoomId;
    let roomId;

    // æ˜¯å¦æœ‰æ›´å¤šæ•°æ®çš„æ ‡å¿—
    let hasMoreData = true;
    let currentMessageId='';
    let firstMessageId='';
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    chatContent.addEventListener('scroll', handleScroll);
    async function handleScroll() {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®
        if (isLoading) return;

        // å½“æ»šåŠ¨æ¡æ»šåŠ¨åˆ°é¡¶éƒ¨ä¸”è¿˜æœ‰æ›´å¤šæ•°æ®æ—¶ï¼Œè¿›è¡Œæ•°æ®åŠ è½½
        if (chatContent.scrollTop === 0) {
            // è®¾ç½®ä¸ºæ­£åœ¨åŠ è½½
            isLoading = true;

            // è°ƒç”¨æ•°æ®åŠ è½½å‡½æ•°
            await fetchChatData()
        }
    }
    const textarea = document.getElementById('message-input');
    // ç¦ç”¨å›è½¦é”®è§¦å‘å‘é€
    textarea.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            // è¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨å‘é€æˆ–è€…ä»€ä¹ˆä¹Ÿä¸åš
            // sendButton.click(); // è‡ªåŠ¨è§¦å‘å‘é€æŒ‰é’®
        }
    });
    document.addEventListener('DOMContentLoaded', function () {

        setRoomIdButton.addEventListener('click', function () {
            if (roomInput.value.trim()) {
                fetchChatNewData();
            } else {
                alert('è¯·è¾“å…¥æˆ¿é—´å·');
            }
        });
    });
    document.getElementById('themeToggle').addEventListener('click', function() {
        const chatBody = document.getElementById('chatContent');
        const button = document.getElementById('themeToggle');

        // Toggle dark mode
        if (chatBody.classList.contains('dark-mode')) {
            chatBody.classList.remove('dark-mode');
            button.textContent = 'ğŸŒ•'; // Moon icon for dark mode
            button.classList.remove('dark-mode');
        } else {
            chatBody.classList.add('dark-mode');
            button.textContent = 'ğŸŒ™'; // Sun icon for light mode
            button.classList.add('dark-mode');
        }
    });
    async function displayChatMessages(messages) {
        let lastTimestamp = null;

        messages.forEach(message => {
            let isMyMessage=false;
            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ·»åŠ  'me' ç±»
            if (message.nickname === localStorage.getItem("nickname")) { // `currentUserId` æ˜¯ä½ éœ€è¦å®šä¹‰çš„å½“å‰ç”¨æˆ·çš„ ID
                isMyMessage=true;
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';

            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ·»åŠ  'me' ç±»
            if (isMyMessage) { // `currentUserId` æ˜¯ä½ éœ€è¦å®šä¹‰çš„å½“å‰ç”¨æˆ·çš„ ID
                messageElement.classList.add('me');
            }
            // æ·»åŠ ç”¨æˆ·å¤´åƒ
            const avatarImg = document.createElement('img');
            avatarImg.src = message.avatar || 'https://via.placeholder.com/40?text=U';
            avatarImg.alt = message.nickname || 'User';
            messageElement.appendChild(avatarImg);

            // æ·»åŠ æ¶ˆæ¯å†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ·»åŠ  'me' ç±»
            if (!isMyMessage) { // `currentUserId` æ˜¯ä½ éœ€è¦å®šä¹‰çš„å½“å‰ç”¨æˆ·çš„ ID
                // æ·»åŠ æ¶ˆæ¯äººæ˜µç§°
                const nicknameDiv = document.createElement('div');
                nicknameDiv.className = 'chat-message-nickname';
                nicknameDiv.textContent = message.nickname || 'User';
                contentDiv.appendChild(nicknameDiv);
            }

            if (message.contentType === 'image') {
                contentDiv.innerHTML = `<img src="${message.content}" alt="image">`;
            } else if (message.contentType === 'video') {
                contentDiv.innerHTML = `<video controls><source src="${message.content}" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚</video>`;
            } else {
                const textP = document.createElement('p');
                textP.textContent = message.content;
                contentDiv.appendChild(textP);
            }

            messageElement.appendChild(contentDiv);


            // å¤„ç†æ—¶é—´æˆ³
            const currentTimestamp = new Date(message.createTime);
            if (lastTimestamp != null && (lastTimestamp-currentTimestamp ) >= 5 * 60 * 1000) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'chat-timestamp';
                timestampDiv.textContent = formatTimestamp(currentTimestamp);

                chatContent.prepend(timestampDiv);
            }
            lastTimestamp = currentTimestamp;
            chatContent.prepend(messageElement);
        });

    }
    async function displayNewChatMessages(messages) {
        let lastTimestamp = null;

        messages.forEach(message => {
            let isMyMessage=false;
            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ·»åŠ  'me' ç±»
            if (message.nickname === localStorage.getItem("nickname")) { // `currentUserId` æ˜¯ä½ éœ€è¦å®šä¹‰çš„å½“å‰ç”¨æˆ·çš„ ID
                isMyMessage=true;
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';

            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ·»åŠ  'me' ç±»
            if (isMyMessage) { // `currentUserId` æ˜¯ä½ éœ€è¦å®šä¹‰çš„å½“å‰ç”¨æˆ·çš„ ID
                messageElement.classList.add('me');
            }

            // æ·»åŠ ç”¨æˆ·å¤´åƒ
            const avatarImg = document.createElement('img');
            avatarImg.src = message.avatar || 'https://via.placeholder.com/40?text=U';
            avatarImg.alt = message.nickname || 'User';
            messageElement.appendChild(avatarImg);

            // æ·»åŠ æ¶ˆæ¯å†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';

            if (!isMyMessage) {
                const nicknameDiv = document.createElement('div');
                nicknameDiv.className = 'chat-message-nickname';
                nicknameDiv.textContent = message.nickname || 'User';
                contentDiv.appendChild(nicknameDiv);
            }

            if (message.contentType === 'image') {
                contentDiv.innerHTML = `<img src="${message.content}" alt="image">`;
            } else if (message.contentType === 'video') {
                contentDiv.innerHTML = `<video controls><source src="${message.content}" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚</video>`;
            } else {
                const textP = document.createElement('p');
                textP.textContent = message.content;
                contentDiv.appendChild(textP);
            }

            messageElement.appendChild(contentDiv);


            // å¤„ç†æ—¶é—´æˆ³
            const currentTimestamp = new Date(message.createTime);
            if (lastTimestamp != null && (currentTimestamp-lastTimestamp) >= 5 * 60 * 1000) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'chat-timestamp';
                timestampDiv.textContent = formatTimestamp(currentTimestamp);

                chatContent.appendChild(timestampDiv);
            }
            lastTimestamp = currentTimestamp;
            chatContent.appendChild(messageElement);
        });
    }
    function formatTimestamp(timestamp) {
        const now = new Date();
        const messageDate = new Date(timestamp);
        const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Shanghai' };

        const timeString = messageDate.toLocaleTimeString('zh-CN', options);

        // å¦‚æœæ˜¯ä»Šå¤©
        if (now.toDateString() === messageDate.toDateString()) {
            return `ä»Šå¤© ${timeString}`;
        }

        // å¦‚æœæ˜¯æ˜¨å¤©
        const yesterday = new Date();
        yesterday.setDate(now.getDate() - 1);
        if (yesterday.toDateString() === messageDate.toDateString()) {
            return `æ˜¨å¤© ${timeString}`;
        }

        // æ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
        const month = messageDate.getMonth() + 1; // æœˆä»½æ˜¯0-11
        const day = messageDate.getDate();
        return `${month}æœˆ${day}æ—¥ ${timeString}`;
    }
    async function fetchChatData() {
        // ç¦ç”¨åˆ·æ–°æŒ‰é’®
        setRoomIdButton.disabled = true;
        if (!roomId) {
            alert('è¯·è®¾ç½®æˆ¿é—´å·');
            return;
        }
        const token = localStorage.getItem('user-token');
        if (null == token) {
            alert("è¯·ç™»å½•")
        }
        fetch('/api/anakki/chat/receive-from-room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify({
                roomId: roomId,
                firstIndex: firstMessageId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    if (data.data.length===0){
                        alert('æ²¡æœ‰æ›´å¤šæ•°æ®');
                    }else{
                        if (!firstMessageId){
                            firstMessageId=data.data[data.data.length-1].id
                        }else if (data.data[data.data.length-1].id<firstMessageId){
                            firstMessageId=data.data[data.data.length-1].id
                        }
                        displayChatMessages(data.data);
                    }
                } else {
                    alert(data.message || 'è·å–æ•°æ®å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            }).finally(() => {
            // å®Œæˆåé‡æ–°å¯ç”¨åˆ·æ–°æŒ‰é’®
            setRoomIdButton.disabled = false;
            isLoading=false;
        });
    }
    // setInterval(fetchChatNewData, 5000);

    async function fetchChatNewData() {
        let isFirst;
        // ç¦ç”¨åˆ·æ–°æŒ‰é’®
        setRoomIdButton.disabled = true;
        if (!roomInput.value.trim()) {
            alert('è¯·è®¾ç½®æˆ¿é—´å·');
            setRoomIdButton.disabled = false; // ç¡®ä¿åœ¨è¾“å…¥æˆ¿é—´å·åæŒ‰é’®ä¸ä¼šç¦ç”¨
            return;
        }
        //ç¬¬ä¸€æ¬¡è¿›å…¥
        if (!oldRoomId) {
            oldRoomId = roomInput.value.trim();
            roomId = roomInput.value.trim();
        } else{
            oldRoomId=roomId
            roomId = roomInput.value.trim();
            if (oldRoomId !== roomId) {
                isFirst=true
                currentMessageId = null;
                document.getElementById('chatContent').innerHTML = '';
            }
        }






        const token = localStorage.getItem('user-token');
        if (!token) {
            alert('è¯·ç™»å½•');
            setRoomIdButton.disabled = false; // ç¡®ä¿åœ¨æœªç™»å½•æ—¶æŒ‰é’®ä¸ä¼šç¦ç”¨
            return;
        }

        try {
            const response = await fetch('/api/anakki/chat/receive-new-from-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': token
                },
                body: JSON.stringify({
                    roomId: roomId,
                    currentIndex: currentMessageId
                })
            });

            const data = await response.json();

            if (data.code === 200) {
                if (data.data.length > 0) {
                    currentMessageId = data.data[data.data.length - 1].id;
                    if (!firstMessageId||isFirst) {
                        firstMessageId = data.data[0].id;
                    } else if (data.data[0].id < firstMessageId) {
                        firstMessageId = data.data[0].id;
                    }
                    await displayNewChatMessages(data.data);
                }
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
        } finally {
            // å®Œæˆåé‡æ–°å¯ç”¨åˆ·æ–°æŒ‰é’®
            setRoomIdButton.disabled = false;
        }
    }


    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);

        // å‘é€æ¶ˆæ¯çš„æŒ‰é’®å’Œè¾“å…¥æ¡†
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');

        sendButton.addEventListener('click', function () {
            // è·å–è¾“å…¥æ¡†çš„æ¶ˆæ¯å†…å®¹
            const messageContent = messageInput.value;

            if (messageContent.trim() === '') {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            // æ„é€ è¯·æ±‚ä½“
            const requestPayload = {
                isTemp: false, // æ ¹æ®éœ€æ±‚è®¾ç½®
                roomId: roomId, // æ›¿æ¢ä¸ºå®é™…çš„æˆ¿é—´ID
                content: messageContent,
                contentType: 'text' // æ ¹æ®éœ€æ±‚è®¾ç½®
            };

            const token = localStorage.getItem('user-token');
            if (null == token) {
                alert("è¯·ç™»å½•")
            }
            sendButton.disabled = true;
            // å‘é€è¯·æ±‚åˆ°åç«¯
            fetch('/api/anakki/chat/send-to-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': token
                },
                body: JSON.stringify(requestPayload)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.data) {
                        // æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                        messageInput.value = '';
                        // å¤„ç†æ¶ˆæ¯å‘é€æˆåŠŸçš„é€»è¾‘ï¼Œä¾‹å¦‚å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©è®°å½•ä¸­
                        console.log('æ¶ˆæ¯å‘é€æˆåŠŸ');
                        fetchChatNewData()
                        sendButton.disabled = false;
                    } else {
                        // å¤„ç†æ¶ˆæ¯å‘é€å¤±è´¥çš„é€»è¾‘
                        console.error('æ¶ˆæ¯å‘é€å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('å‘é€è¯·æ±‚å¤±è´¥', error);
                });
        });
    }

    document.getElementById('message-input').addEventListener('focus', function() {
        // è®©è¾“å…¥æ¡†æ»šåŠ¨åˆ°è§†å›¾ä¸­
        this.scrollIntoView({ behavior: 'smooth' });
    });


</script>
</body>
</html>
