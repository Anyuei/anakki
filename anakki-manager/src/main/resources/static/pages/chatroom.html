<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="时光胶囊,Anakki的个人网站,摄影,博客,技术分享。">
    <meta name="author" content="Anakki">
    <title>Anakki-World</title>
    <!-- Fonts -->

    <!-- Theme CSS -->
    <link type="text/css" href="../assets/css/theme.css" rel="stylesheet">
    <!-- Demo CSS - No need to use these in your project -->
    <link type="text/css" href="../assets/css/demo.css" rel="stylesheet">

    <style>
        body {
            color: #495751b8;
            background-color: rgba(3, 94, 0, 0.27);
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Your existing CSS styles */
        .chat-header {
            background-color: rgba(0, 204, 126, 0);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(221, 221, 221, 0.16);
            position: fixed;
            top: 60px;
            width: 100%;
            z-index: 1;
        }

        .chat-header h4 {
            margin: 0;
        }

        .chat-header h2 {
            margin-left: 10px;
            color: #f0f0f0;
        }

        .chat-body {
            position: relative;
            flex: 1;
            margin-top: 123px;
            margin-bottom: 60px;
            overflow-y: auto;
            padding: 15px;
            background-color: #ccc0;
            transition: background-color 3s ease, color 3s ease;
        }

        /* 头像和聊天气泡靠右 */
        .chat-message.me {
            justify-content: flex-end;
        }

        .chat-message.me .chat-message-content {
            background-color: rgba(178, 255, 117, 0);
            text-align: right;
            align-self: flex-end; /* 确保聊天气泡靠右 */
            border-radius: 9px;
        }
        .chat-message.me .chat-message-content p{
            background-color: rgba(178, 255, 117, 0.56);
            text-align: right;
            align-self: flex-end; /* 确保聊天气泡靠右 */
            border-radius: 9px;
            color: black;
            font-weight: bold;
        }

        .chat-message.me .chat-message-content div{
            background-color: rgba(178, 255, 117, 0);
            text-align: right;
            align-self: flex-end; /* 确保聊天气泡靠右 */
            border-radius: 9px;
        }
        .chat-message.me img {
            order: 1; /* 确保头像在聊天气泡后面 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            margin-right: 0 !important;
        }

        /* 其他聊天消息的样式保持不变 */
        .chat-message {
            display: flex;
            margin-bottom: 10px;
        }

        .chat-message img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px; /* 默认头像在聊天气泡前面 */
        }

        .chat-message-content {
            max-width: 80%;
            border-radius: 9px;
            color: #131313d9;
            background-color: rgba(245, 245, 245, 0);
        }
        .chat-message .chat-message-content div{
            background-color: rgba(178, 255, 117, 0);
            text-align: left;
            align-self: flex-end; /* 确保聊天气泡靠右 */
            border-radius: 9px;
        }
        .chat-message .chat-message-content p {
            background-color: rgba(0, 0, 0, 0.25);
            padding: 10px;
            border-radius: 10px;
            margin: 0;
            color: white;
            white-space: pre-wrap;
        }

        .chat-footer {
            border-top: 1px solid #0000004d;
            padding: 10px;
            background-color: #242424;
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .chat-footer textarea {
            flex: 1;
            margin-right: 10px;
        }

        .chat-footer button {
            background-color: #77777780;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
        }
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa00;
        }

        .chat-title {
            margin-right: auto;
        }

        .room-id {
            margin: 0 auto;
            text-align: center;
        }

        .room-id-input {
            display: flex;
            align-items: center;
        }

        #roomInput {
            margin-right: 10px; /* 输入框和按钮之间的间距 */
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            padding: 20px;
            display: none; /* 初始状态下隐藏 */
            flex-shrink: 0;
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 20px;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar ul li {
            margin-bottom: 10px;
            color: #ecf0f1;
            cursor: pointer;
        }
        .chat-message-nickname{
            font-weight: bold;
        }
        .chat-timestamp {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin: 10px 0;
            font-style: italic;
        }

        .dark-mode {
            background-color: #333;
            color: #f0f0f0;
        }

        .theme-toggle {
            position: absolute;
            top: 53px;
            right: 46%;
            border: none;
            border-radius: 100%;
            cursor: pointer;
            font-size: 2rem;
            transition: background-color 3s ease, color 3s ease;
            background-color: rgba(51, 51, 51, 0);
        }

        .theme-toggle.dark-mode {
            background-color: rgba(51, 51, 51, 0);
            color: #f0f0f0;
        }
        button:focus {
            outline: 0 dotted;
            outline: 0 auto -webkit-focus-ring-color;
        }
        .form-control {
            display: block;
            width: 100%;
            padding: .4rem 0.5rem;
            font-size: .875rem;
            line-height: 1.6;
            color: #495057;
            background-color: #fff0;
            background-clip: padding-box;
            border: .0625rem solid #ced4da40;
            border-radius: .375rem;
            box-shadow: none;
            transition: all 0.2s ease-in-out;
        }
    </style>

</head>
<body>
<!--通用顶部导航-->
<div id="header"></div>
<main class="main">
    <div class="bg-cover bg-size--cover" data-spotlight="fullscreen"
         style="background-image: url('https://securex-1258150206.cos.ap-beijing.myqcloud.com/backend/DSC07694.jpg')">
        <div class="chat-section">
            <!-- Chat Header -->
            <div class="chat-header">
                <h4 class="chat-title toggle-sidebar-button" id="toggleSidebarButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid" viewBox="0 0 16 16">
                        <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                    </svg>
                </h4>
                <button id="themeToggle" class="theme-toggle">🌕</button>
                <div class="room-id-input">
                    <input class="form-control" type="text" id="roomInput" placeholder="请输入房间号" data-emojiable="true">
                    <div class="btn input-group-append" id="setRoomIdButton" class="btn btn-default">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Chat Body -->
            <!-- Chat content here -->

            <div class="chat-body" id="chatContent">
            </div>
            <!-- Chat Footer -->
            <div class="chat-footer">
                <textarea id="message-input" class="form-control" data-emojiable="true" placeholder="输入消息..." rows="1" style="resize: none;"></textarea>
                <button type="button" id="send-button">发送</button>
            </div>
        </div>
    </div>
</main>
<!-- 页面底部 -->
<div id="footer"></div>
<!-- Core -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/popper/popper.min.js"></script>
<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<!-- FontAwesome 5 -->
<script src="../assets/vendor/fontawesome/js/fontawesome-all.min.js" defer></script>
<!-- Page plugins -->
<script src="../assets/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>
<script src="../assets/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<script src="../assets/vendor/input-mask/input-mask.min.js"></script>
<script src="../assets/vendor/nouislider/js/nouislider.min.js"></script>
<script src="../assets/vendor/textarea-autosize/textarea-autosize.min.js"></script>
<!-- Theme JS -->
<script src="../assets/js/theme.js"></script>



<script>
    // 是否正在加载数据的标志
    let isLoading = false;
    const setRoomIdButton = document.getElementById('setRoomIdButton');
    const roomInput = document.getElementById('roomInput');
    const roomIdElement = document.getElementById('roomId');
    const chatContent = document.getElementById('chatContent');
    const roomName = document.getElementById('roomName');
    let oldRoomId;
    let roomId;

    // 是否有更多数据的标志
    let hasMoreData = true;
    let currentMessageId='';
    let firstMessageId='';
    // 监听滚动事件
    chatContent.addEventListener('scroll', handleScroll);
    async function handleScroll() {
        // 检查是否正在加载数据
        if (isLoading) return;

        // 当滚动条滚动到顶部且还有更多数据时，进行数据加载
        if (chatContent.scrollTop === 0 && hasMoreData) {
            // 设置为正在加载
            isLoading = true;

            // 调用数据加载函数
            await fetchChatData()
        }
    }
    const textarea = document.getElementById('message-input');
    // 禁用回车键触发发送
    textarea.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // 阻止默认行为
            // 这里可以选择自动发送或者什么也不做
            // sendButton.click(); // 自动触发发送按钮
        }
    });
    document.addEventListener('DOMContentLoaded', function () {

        setRoomIdButton.addEventListener('click', function () {
            roomId = roomInput.value.trim();
            if (roomId) {
                fetchChatNewData();
            } else {
                alert('请输入房间号');
            }
        });
    });
    document.getElementById('themeToggle').addEventListener('click', function() {
        const chatBody = document.getElementById('chatContent');
        const button = document.getElementById('themeToggle');

        // Toggle dark mode
        if (chatBody.classList.contains('dark-mode')) {
            chatBody.classList.remove('dark-mode');
            button.textContent = '🌕'; // Moon icon for dark mode
            button.classList.remove('dark-mode');
        } else {
            chatBody.classList.add('dark-mode');
            button.textContent = '🌙'; // Sun icon for light mode
            button.classList.add('dark-mode');
        }
    });
    async function displayChatMessages(messages) {
        let lastTimestamp = null;

        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';

            // 添加用户头像
            const avatarImg = document.createElement('img');
            avatarImg.src = message.avatar || 'https://via.placeholder.com/40?text=U';
            avatarImg.alt = message.nickname || 'User';
            messageElement.appendChild(avatarImg);

            // 添加消息内容
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            // 添加消息人昵称
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'chat-message-nickname';
            nicknameDiv.textContent = message.nickname || 'User';
            contentDiv.appendChild(nicknameDiv);

            if (message.contentType === 'image') {
                contentDiv.innerHTML = `<img src="${message.content}" alt="image">`;
            } else if (message.contentType === 'video') {
                contentDiv.innerHTML = `<video controls><source src="${message.content}" type="video/mp4">您的浏览器不支持视频标签。</video>`;
            } else {
                const textP = document.createElement('p');
                textP.textContent = message.content;
                contentDiv.appendChild(textP);
            }

            messageElement.appendChild(contentDiv);

            // 如果是当前用户的消息，添加 'me' 类
            if (message.nickname === localStorage.getItem("nickname")) { // `currentUserId` 是你需要定义的当前用户的 ID
                messageElement.classList.add('me');
            }
            // 处理时间戳
            const currentTimestamp = new Date(message.createTime);
            if (lastTimestamp != null && (lastTimestamp-currentTimestamp ) >= 5 * 60 * 1000) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'chat-timestamp';
                timestampDiv.textContent = formatTimestamp(currentTimestamp);

                chatContent.prepend(timestampDiv);
            }
            lastTimestamp = currentTimestamp;
            chatContent.prepend(messageElement);
        });

    }
    async function displayNewChatMessages(messages) {
        let lastTimestamp = null;

        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';

            // 添加用户头像
            const avatarImg = document.createElement('img');
            avatarImg.src = message.avatar || 'https://via.placeholder.com/40?text=U';
            avatarImg.alt = message.nickname || 'User';
            messageElement.appendChild(avatarImg);

            // 添加消息内容
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            // 添加消息人昵称
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'chat-message-nickname';
            nicknameDiv.textContent = message.nickname || 'User';
            contentDiv.appendChild(nicknameDiv);

            if (message.contentType === 'image') {
                contentDiv.innerHTML = `<img src="${message.content}" alt="image">`;
            } else if (message.contentType === 'video') {
                contentDiv.innerHTML = `<video controls><source src="${message.content}" type="video/mp4">您的浏览器不支持视频标签。</video>`;
            } else {
                const textP = document.createElement('p');
                textP.textContent = message.content;
                contentDiv.appendChild(textP);
            }

            messageElement.appendChild(contentDiv);

            // 如果是当前用户的消息，添加 'me' 类
            if (message.nickname === localStorage.getItem("nickname")) { // `currentUserId` 是你需要定义的当前用户的 ID
                messageElement.classList.add('me');
            }
            // 处理时间戳
            const currentTimestamp = new Date(message.createTime);
            if (lastTimestamp != null && (currentTimestamp-lastTimestamp) >= 5 * 60 * 1000) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'chat-timestamp';
                timestampDiv.textContent = formatTimestamp(currentTimestamp);

                chatContent.appendChild(timestampDiv);
            }
            lastTimestamp = currentTimestamp;
            chatContent.appendChild(messageElement);
        });
    }
    function formatTimestamp(timestamp) {
        const now = new Date();
        const messageDate = new Date(timestamp);
        const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Shanghai' };

        const timeString = messageDate.toLocaleTimeString('zh-CN', options);

        // 如果是今天
        if (now.toDateString() === messageDate.toDateString()) {
            return `今天 ${timeString}`;
        }

        // 如果是昨天
        const yesterday = new Date();
        yesterday.setDate(now.getDate() - 1);
        if (yesterday.toDateString() === messageDate.toDateString()) {
            return `昨天 ${timeString}`;
        }

        // 显示完整日期
        const month = messageDate.getMonth() + 1; // 月份是0-11
        const day = messageDate.getDate();
        return `${month}月${day}日 ${timeString}`;
    }
    async function fetchChatData() {
        // 禁用刷新按钮
        setRoomIdButton.disabled = true;
        if (!roomId) {
            alert('请设置房间号');
            return;
        }
        const token = localStorage.getItem('user-token');
        if (null == token) {
            alert("请登录")
        }
        fetch('/api/anakki/chat/receive-from-room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'authorization': token
            },
            body: JSON.stringify({
                roomId: roomId,
                firstIndex: firstMessageId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    if (data.data.length===0){
                        // 没有更多数据了
                        hasMoreData = false;
                        alert('没有更多数据');
                    }
                    if (!firstMessageId){
                        firstMessageId=data.data[data.data.length-1].id
                    }else if (data.data[data.data.length-1].id<firstMessageId){
                        firstMessageId=data.data[data.data.length-1].id
                    }
                    displayChatMessages(data.data);
                    //roomIdElement.textContent = roomId;
                } else {
                    alert(data.message || '获取数据失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            }).finally(() => {
            // 完成后重新启用刷新按钮
            setRoomIdButton.disabled = false;
            isLoading=false;
        });
    }
    // setInterval(fetchChatNewData, 5000);

    async function fetchChatNewData() {
        if (!oldRoomId) {
            oldRoomId = roomInput.value.trim();
            roomId = roomInput.value.trim();
        } else {
            if (oldRoomId !== roomInput.value.trim()) {
                currentMessageId = null;
            }
        }

        // 禁用刷新按钮
        setRoomIdButton.disabled = true;
        if (!roomId) {
            alert('请设置房间号');
            setRoomIdButton.disabled = false; // 确保在输入房间号后按钮不会禁用
            return;
        }

        const token = localStorage.getItem('user-token');
        if (!token) {
            alert('请登录');
            setRoomIdButton.disabled = false; // 确保在未登录时按钮不会禁用
            return;
        }

        try {
            const response = await fetch('/api/anakki/chat/receive-new-from-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': token
                },
                body: JSON.stringify({
                    roomId: roomId,
                    currentIndex: currentMessageId
                })
            });

            const data = await response.json();

            if (data.code === 200) {
                if (data.data.length > 0) {
                    currentMessageId = data.data[data.data.length - 1].id;
                    if (!firstMessageId) {
                        firstMessageId = data.data[0].id;
                    } else if (data.data[0].id < firstMessageId) {
                        firstMessageId = data.data[0].id;
                    }
                    await displayNewChatMessages(data.data);
                }
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
        } finally {
            // 完成后重新启用刷新按钮
            setRoomIdButton.disabled = false;
        }
    }


    window.onload = function () {
        $('#header').load("../pages/header.html", loadPersonDetail);

        // 发送消息的按钮和输入框
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');

        sendButton.addEventListener('click', function () {
            // 获取输入框的消息内容
            const messageContent = messageInput.value;

            if (messageContent.trim() === '') {
                alert('请输入消息内容');
                return;
            }

            // 构造请求体
            const requestPayload = {
                isTemp: false, // 根据需求设置
                roomId: roomId, // 替换为实际的房间ID
                content: messageContent,
                contentType: 'text' // 根据需求设置
            };

            const token = localStorage.getItem('user-token');
            if (null == token) {
                alert("请登录")
            }
            sendButton.disabled = true;
            // 发送请求到后端
            fetch('/api/anakki/chat/send-to-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'authorization': token
                },
                body: JSON.stringify(requestPayload)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.data) {
                        // 消息发送成功，清空输入框
                        messageInput.value = '';
                        // 处理消息发送成功的逻辑，例如将消息添加到聊天记录中
                        console.log('消息发送成功');
                        fetchChatNewData()
                        sendButton.disabled = false;
                    } else {
                        // 处理消息发送失败的逻辑
                        console.error('消息发送失败');
                    }
                })
                .catch(error => {
                    console.error('发送请求失败', error);
                });
        });
    }

    document.getElementById('message-input').addEventListener('focus', function() {
        // 让输入框滚动到视图中
        this.scrollIntoView({ behavior: 'smooth' });
    });
</script>
</body>
</html>
